/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var pe=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Le=Object.prototype.hasOwnProperty;var F=(b,s)=>()=>(b&&(s=b(b=0)),s);var B=(b,s)=>{for(var e in s)pe(b,e,{get:s[e],enumerable:!0})},Re=(b,s,e,t)=>{if(s&&typeof s=="object"||typeof s=="function")for(let o of Oe(s))!Le.call(b,o)&&o!==e&&pe(b,o,{get:()=>s[o],enumerable:!(t=Me(s,o))||t.enumerable});return b};var ue=b=>Re(pe({},"__esModule",{value:!0}),b);var A,i,w=F(()=>{A=class{constructor(){this.debugEnabled=!1}static getInstance(){return A.instance||(A.instance=new A),A.instance}setDebugEnabled(s){this.debugEnabled=s}debug(s,...e){this.debugEnabled&&console.log(`[Open Notebook Debug] ${s}`,...e)}info(s,...e){console.log(`[Open Notebook] ${s}`,...e)}warn(s,...e){console.warn(`[Open Notebook Warning] ${s}`,...e)}error(s,e){console.error(`[Open Notebook Error] ${s}`,e)}},i=A.getInstance()});var L,c,E=F(()=>{L=require("obsidian"),c=class{static success(s,e){new L.Notice(`\u2713 ${s}`,e)}static error(s,e){new L.Notice(`\u2717 ${s}`,e||5e3)}static warn(s,e){new L.Notice(`\u26A0 ${s}`,e)}static info(s,e){new L.Notice(s,e)}static debounced(s,e,t){let o=Date.now(),n=this.lastNoticeTime.get(s);(!n||o-n>this.DEBOUNCE_MS)&&(new L.Notice(e,t),this.lastNoticeTime.set(s,o))}static loading(s){return new L.Notice(`\u23F3 ${s}`,0)}static hideNotice(s){s.hide()}};c.lastNoticeTime=new Map,c.DEBOUNCE_MS=3e3});var we,R,ge=F(()=>{we=require("obsidian");w();E();R=class extends we.Modal{constructor(e,t,o,n,r){super(e);this.transformations=[];this.selectedTransformation=null;this.isLoading=!1;this.plugin=t,this.text=o,this.onSelect=n,this.onTransformStart=r}async onOpen(){let{contentEl:e,modalEl:t}=this;e.empty(),e.addClass("open-notebook-transform-modal"),t&&(t.style.width="90vw",t.style.maxWidth="1200px"),e.createDiv({cls:"transform-header-container"}).createEl("h2",{text:"Transform Text"});let n=e.createDiv({cls:"transform-search-container"});this.searchInputEl=n.createEl("input",{type:"text",placeholder:"Search transformations...",cls:"transform-search-input"}),this.searchInputEl.addEventListener("input",()=>{this.filterTransformations()});let r=e.createDiv({cls:"transform-results-section"}),a=r.createDiv({cls:"transform-list-container"});a.createEl("h3",{text:"Available Transformations"}),this.listEl=a.createDiv({cls:"transform-list"});let l=r.createDiv({cls:"transform-preview-pane"});l.createEl("h3",{text:"Details"}),this.previewEl=l.createDiv({cls:"transform-preview-content"}),await this.loadTransformations()}onClose(){let{contentEl:e}=this;e.empty()}async loadTransformations(){if(!this.isLoading){this.isLoading=!0,this.listEl.empty(),this.previewEl.empty(),this.listEl.createDiv({cls:"transform-loading",text:"Loading transformations..."});try{let e=this.plugin.getAPIClient();this.transformations=await e.getTransformations(),i.info(`Loaded ${this.transformations.length} transformations`),this.renderTransformationsList(),this.transformations.length>0?this.selectTransformation(this.transformations[0]):this.showEmptyState()}catch(e){i.error("Failed to load transformations",e),this.listEl.empty(),this.listEl.createDiv({cls:"transform-error",text:`Failed to load transformations: ${e.message||"Unknown error"}`})}finally{this.isLoading=!1}}}showEmptyState(){this.listEl.empty(),this.previewEl.empty(),this.listEl.createDiv({cls:"transform-empty-state",text:"No transformations available. Please create transformations in Open Notebook first."}),this.previewEl.createDiv({cls:"transform-empty-state",text:"Select a transformation to see details"})}filterTransformations(){let e=this.searchInputEl.value.toLowerCase();this.renderTransformationsList(e)}renderTransformationsList(e=""){this.listEl.empty();let t=this.transformations.filter(n=>e?n.name.toLowerCase().includes(e)||n.description.toLowerCase().includes(e):!0);if(t.length===0){this.listEl.createDiv({cls:"transform-no-results",text:e?"No matching transformations found":"No transformations available"});return}this.listEl.createDiv({cls:"transform-count"}).setText(`${t.length} transformation${t.length===1?"":"s"} available`);for(let n of t){let r=this.listEl.createDiv({cls:"transform-item"});r.createDiv({cls:"transform-icon"}).setText(n.is_system?"\u2699\uFE0F":"\u{1F527}");let l=r.createDiv({cls:"transform-content"});l.createDiv({cls:"transform-title"}).setText(n.name),l.createDiv({cls:"transform-description"}).setText(n.description||"No description"),r.addEventListener("click",()=>{this.selectTransformation(n)})}}selectTransformation(e){this.selectedTransformation=e;let t=this.listEl.querySelectorAll(".transform-item"),o=this.searchInputEl.value.toLowerCase(),n=this.transformations.filter(r=>o?r.name.toLowerCase().includes(o)||r.description.toLowerCase().includes(o):!0);t.forEach((r,a)=>{n[a]===e?r.addClass("selected"):r.removeClass("selected")}),this.renderPreview(e)}async renderPreview(e){this.previewEl.empty(),this.previewEl.createEl("h4",{text:e.name});let t=this.previewEl.createDiv({cls:"transform-preview-metadata"}),o=t.createDiv();if(o.createEl("strong",{text:"Type: "}),o.createSpan({text:e.is_system?"System":"Custom"}),e.model){let p=t.createDiv();p.createEl("strong",{text:"Model: "}),p.createSpan({text:e.model})}if(e.temperature!==void 0){let p=t.createDiv();p.createEl("strong",{text:"Temperature: "}),p.createSpan({text:e.temperature.toString()})}if(e.max_tokens){let p=t.createDiv();p.createEl("strong",{text:"Max Tokens: "}),p.createSpan({text:e.max_tokens.toString()})}e.description&&(this.previewEl.createEl("h5",{text:"Description"}),this.previewEl.createDiv({cls:"transform-preview-description"}).setText(e.description)),e.prompt_template&&(this.previewEl.createEl("h5",{text:"Prompt Template"}),this.previewEl.createDiv({cls:"transform-preview-prompt"}).createEl("pre").createEl("code",{text:e.prompt_template})),this.previewEl.createEl("h5",{text:"Input Text Preview"});let n=this.previewEl.createDiv({cls:"transform-text-preview"}),r=this.text.length>500?this.text.substring(0,500)+"...":this.text;n.setText(r),this.previewEl.createDiv({cls:"transform-char-count"}).setText(`${this.text.length} characters`);let l=this.previewEl.createDiv({cls:"transform-preview-actions"});l.createEl("button",{text:"Apply Transformation",cls:"mod-cta"}).addEventListener("click",async p=>{p.preventDefault(),p.stopPropagation(),await this.executeTransformation(e)}),l.createEl("button",{text:"Cancel"}).addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),this.close()})}async executeTransformation(e){let t=this.onTransformStart?this.onTransformStart():null;this.close();try{let o=this.plugin.getAPIClient(),n=this.plugin.settings.defaultTransformationModel,r=await o.executeTransformation(e.id,this.text,n);i.info("Transformation complete:",e.id),this.onSelect(r.output,e)}catch(o){i.error("Failed to execute transformation",o),t&&typeof t.setError=="function"?t.setError(o.message||"Unknown error occurred during transformation"):c.error(`Failed to transform text: ${o.message||"Unknown error"}`)}}}});var te={};B(te,{TransformResultModal:()=>_});var ke,_,U=F(()=>{ke=require("obsidian");w();E();_=class extends ke.Modal{constructor(e,t,o){super(e);this.options=null;this.isLoading=!0;this.plugin=t,o&&(this.options=o,this.isLoading=!1)}setResult(e){this.options=e,this.isLoading=!1,this.render()}setError(e){this.isLoading=!1;let{contentEl:t}=this;t.empty(),t.addClass("transform-result-modal");let o=t.createDiv({cls:"transform-result-error"});o.createEl("h3",{text:"Transformation Failed"}),o.createEl("p",{text:e}),o.createEl("button",{text:"Close"}).addEventListener("click",()=>this.close())}async onOpen(){this.render()}render(){let{contentEl:e,modalEl:t}=this;if(e.empty(),e.addClass("transform-result-modal"),t&&(t.style.width="90vw",t.style.maxWidth="1400px"),this.isLoading||!this.options){this.renderLoadingState();return}let o=e.createDiv({cls:"transform-result-header"});o.createEl("h2",{text:"Transformation Complete"}),o.createDiv({cls:"transform-result-info"}).createEl("span",{text:`${this.options.transformation.name}`,cls:"transform-result-name"});let r=e.createDiv({cls:"transform-result-preview"}),a=r.createDiv({cls:"transform-result-column"});a.createEl("h3",{text:"Original"}),a.createDiv({cls:"transform-result-content"}).createEl("pre").createEl("code",{text:this.options.originalText}),a.createDiv({cls:"transform-result-stats"}).setText(this.getStats(this.options.originalText));let p=r.createDiv({cls:"transform-result-column"});p.createEl("h3",{text:"Transformed"}),p.createDiv({cls:"transform-result-content"}).createEl("pre").createEl("code",{text:this.options.transformedText}),p.createDiv({cls:"transform-result-stats"}).setText(this.getStats(this.options.transformedText));let y=e.createDiv({cls:"transform-result-actions"}),k=y.createDiv({cls:"transform-result-primary-actions"});k.createEl("button",{text:this.options.context.type==="file"?"Replace File":"Accept",cls:"mod-cta"}).addEventListener("click",async()=>{await this.handleAccept()}),this.options.context.type==="file"&&this.options.context.file&&k.createEl("button",{text:"Create New Note",cls:"mod-cta"}).addEventListener("click",async()=>{await this.handleCreateNewNote()}),k.createEl("button",{text:"Copy to Clipboard"}).addEventListener("click",()=>{this.handleCopyToClipboard()});let N=y.createDiv({cls:"transform-result-secondary-actions"});this.options.context.onRetry&&N.createEl("button",{text:"Retry"}).addEventListener("click",()=>{this.handleRetry()}),N.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.close()})}onClose(){let{contentEl:e}=this;e.empty()}getStats(e){let t=e.length,o=e.trim().split(/\s+/).length,n=e.split(`
`).length;return`${t.toLocaleString()} characters \xB7 ${o.toLocaleString()} words \xB7 ${n.toLocaleString()} lines`}async handleAccept(){if(this.options)try{this.options.context.type==="file"&&this.options.context.file?(await this.app.vault.modify(this.options.context.file,this.options.transformedText),c.success(`File "${this.options.context.file.basename}" updated`)):this.options.context.onAccept&&(this.options.context.onAccept(this.options.transformedText),c.success("Transformation applied")),i.info("Transformation accepted"),this.close()}catch(e){i.error("Failed to accept transformation",e),c.error(`Failed to apply transformation: ${e.message||"Unknown error"}`)}}async handleCreateNewNote(){if(this.options)try{if(!this.options.context.file){c.warn("No source file available");return}let e=this.options.context.file,t=e.basename,o=this.options.transformation.name.replace(/\s+/g,"-").toLowerCase(),n=`${t} - ${o}.md`,r=e.parent?`${e.parent.path}/${n}`:n,a=r,l=1;for(;await this.app.vault.adapter.exists(a);)a=`${r.replace(".md","")} ${l}.md`,l++;let d=await this.app.vault.create(a,this.options.transformedText);c.success(`Created new note: ${d.basename}`),i.info("Created new note with transformation:",d.path),await this.app.workspace.getLeaf(!1).openFile(d),this.close()}catch(e){i.error("Failed to create new note",e),c.error(`Failed to create new note: ${e.message||"Unknown error"}`)}}handleCopyToClipboard(){this.options&&navigator.clipboard.writeText(this.options.transformedText).then(()=>{c.success("Copied to clipboard"),i.info("Transformation copied to clipboard")}).catch(e=>{i.error("Failed to copy to clipboard",e),c.error("Failed to copy to clipboard")})}handleRetry(){i.info("Retrying transformation"),this.close(),this.options&&this.options.context.onRetry&&this.options.context.onRetry()}renderLoadingState(){let{contentEl:e}=this;e.createDiv({cls:"transform-result-header"}).createEl("h2",{text:"Transforming..."});let o=e.createDiv({cls:"transform-result-loading"});o.createDiv({cls:"transform-loading-spinner"}).setText("\u2699\uFE0F"),o.createDiv({cls:"transform-loading-text"}).setText("Processing your transformation..."),o.createDiv({cls:"transform-loading-hint"}).setText("This may take a few moments depending on the size of your content.")}}});var Pe={};B(Pe,{PodcastGenerationModal:()=>me});var Ce,me,Ne=F(()=>{Ce=require("obsidian"),me=class extends Ce.Modal{constructor(e){super(e);this.isLoading=!0;this.successMessage=null;this.errorMessage=null}setSuccess(e,t=2e3){this.isLoading=!1,this.successMessage=e,this.render(),setTimeout(()=>{this.close()},t)}setError(e){this.isLoading=!1,this.errorMessage=e,this.render()}async onOpen(){this.render()}render(){let{contentEl:e}=this;e.empty(),e.addClass("podcast-generation-modal"),this.isLoading?this.renderLoadingState():this.successMessage?this.renderSuccessState():this.errorMessage&&this.renderErrorState()}onClose(){let{contentEl:e}=this;e.empty()}renderLoadingState(){let{contentEl:e}=this;e.createDiv({cls:"podcast-generation-header"}).createEl("h2",{text:"Generating Podcast..."});let o=e.createDiv({cls:"podcast-generation-loading"});o.createDiv({cls:"podcast-loading-spinner"}).setText("\u{1F399}\uFE0F"),o.createDiv({cls:"podcast-loading-text"}).setText("Submitting podcast generation job..."),o.createDiv({cls:"podcast-loading-hint"}).setText("This will take a few minutes. You can check back later to see your podcast.")}renderSuccessState(){let{contentEl:e}=this;e.createDiv({cls:"podcast-generation-header"}).createEl("h2",{text:"Podcast Generation Started!"});let o=e.createDiv({cls:"podcast-generation-success"});o.createDiv({cls:"podcast-success-icon"}).setText("\u2705"),o.createDiv({cls:"podcast-success-text"}).setText(this.successMessage||"Your podcast is being generated."),o.createDiv({cls:"podcast-success-hint"}).setText("The podcast will appear in the episodes list once completed.")}renderErrorState(){let{contentEl:e}=this;e.createDiv({cls:"podcast-generation-header"}).createEl("h2",{text:"Generation Failed"});let o=e.createDiv({cls:"podcast-generation-error"});o.createDiv({cls:"podcast-error-icon"}).setText("\u274C"),o.createDiv({cls:"podcast-error-text"}).setText(this.errorMessage||"Failed to generate podcast"),o.createEl("button",{text:"Close",cls:"mod-cta"}).addEventListener("click",()=>this.close())}}});var Ie={};B(Ie,{PodcastModal:()=>fe});var D,fe,Te=F(()=>{D=require("obsidian");w();E();fe=class extends D.Modal{constructor(e,t,o,n){super(e);this.episodes=[];this.episodeProfiles=[];this.speakerProfiles=[];this.selectedEpisodeProfile="";this.selectedSpeakerProfile="";this.isGenerating=!1;this.currentAudio=null;this.statusCheckInterval=null;this.plugin=t,this.notebookId=o,this.notebookName=n}async onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("open-notebook-podcast-modal"),e.createEl("h2",{text:`Podcasts - ${this.notebookName}`}),e.createDiv({cls:"podcast-description"}).createEl("p",{text:"Generate AI-powered podcast episodes from your notebook sources."}),await this.loadProfiles(),await this.loadEpisodes(),this.renderGenerateSection(),this.renderEpisodesList(),this.startStatusPolling()}async onClose(){let{contentEl:e}=this;this.currentAudio&&(this.currentAudio.pause(),this.currentAudio=null),this.statusCheckInterval&&(window.clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),e.empty()}async loadProfiles(){try{let e=this.plugin.getAPIClient();this.episodeProfiles=await e.getEpisodeProfiles(),i.info(`Loaded ${this.episodeProfiles.length} episode profiles`),this.speakerProfiles=await e.getSpeakerProfiles(),i.info(`Loaded ${this.speakerProfiles.length} speaker profiles`),this.episodeProfiles.length>0&&(this.selectedEpisodeProfile=this.episodeProfiles[0].name),this.speakerProfiles.length>0&&(this.selectedSpeakerProfile=this.speakerProfiles[0].name)}catch(e){i.error("Failed to load podcast profiles",e),c.error("Failed to load podcast profiles")}}async loadEpisodes(){try{let t=await this.plugin.getAPIClient().getPodcastEpisodes();this.episodes=t.filter(o=>{var n;return(n=o.name)==null?void 0:n.includes(this.notebookName)}),i.info(`Loaded ${this.episodes.length} podcast episodes for notebook "${this.notebookName}" (filtered from ${t.length} total)`)}catch(e){i.error("Failed to load podcast episodes",e),c.error("Failed to load podcast episodes"),this.episodes=[]}}renderGenerateSection(){let{contentEl:e}=this,t=e.querySelector(".podcast-generate-section");t?t.empty():t=e.createDiv({cls:"podcast-generate-section"}),new D.Setting(t).setName("Episode Profile").setDesc("Select the episode profile for podcast generation").addDropdown(o=>{this.episodeProfiles.forEach(n=>{o.addOption(n.name,n.name)}),this.selectedEpisodeProfile&&o.setValue(this.selectedEpisodeProfile),o.onChange(n=>{this.selectedEpisodeProfile=n,i.debug(`Selected episode profile: ${n}`)})}),new D.Setting(t).setName("Speaker Profile").setDesc("Select the speaker profile for podcast voices").addDropdown(o=>{this.speakerProfiles.forEach(n=>{o.addOption(n.name,n.name)}),this.selectedSpeakerProfile&&o.setValue(this.selectedSpeakerProfile),o.onChange(n=>{this.selectedSpeakerProfile=n,i.debug(`Selected speaker profile: ${n}`)})}),new D.Setting(t).setName("Generate New Podcast").setDesc("Create a new AI-generated podcast episode from all sources in this notebook").addButton(o=>o.setButtonText(this.isGenerating?"Generating...":"Generate Podcast").setDisabled(this.isGenerating||!this.selectedEpisodeProfile||!this.selectedSpeakerProfile).setCta().onClick(async()=>{await this.generatePodcast()}))}renderEpisodesList(){let{contentEl:e}=this,t=e.querySelector(".podcast-episodes-container");if(t?t.empty():t=e.createDiv({cls:"podcast-episodes-container"}),this.episodes.length===0){t.createEl("p",{text:"No podcast episodes yet. Generate your first podcast above!",cls:"podcast-empty-state"});return}t.createEl("h3",{text:"Episodes"}),[...this.episodes].sort((n,r)=>{let a=n.created?new Date(n.created).getTime():0;return(r.created?new Date(r.created).getTime():0)-a}).forEach(n=>{this.renderEpisodeItem(t,n)})}renderEpisodeItem(e,t){let o=e.createDiv({cls:"podcast-episode-item"}),r=o.createDiv({cls:"podcast-episode-header"}).createDiv({cls:"podcast-episode-title"});r.createSpan({text:t.name||"Untitled Episode",cls:"episode-title-text"});let a=r.createSpan({text:this.getStatusText(t.job_status),cls:`episode-status status-${t.job_status}`}),l=o.createDiv({cls:"podcast-episode-meta"});if(t.created){let u=new Date(t.created).toLocaleDateString();l.createSpan({text:`Created: ${u}`,cls:"episode-meta-date"})}let d=o.createDiv({cls:"podcast-episode-actions"});if(t.job_status==="completed"&&(t.audio_url||t.audio_file))d.createEl("button",{text:"\u25B6 Play",cls:"mod-cta podcast-action-button"}).addEventListener("click",()=>this.playEpisode(t)),d.createEl("button",{text:"\u2B07 Download",cls:"podcast-action-button"}).addEventListener("click",()=>this.downloadEpisode(t)),d.createEl("button",{text:"\u{1F4DD} Save as Note",cls:"podcast-action-button"}).addEventListener("click",()=>this.saveEpisodeAsNote(t));else if(t.job_status==="processing"||t.job_status==="pending"||t.job_status==="running"){let u=t.job_status==="processing"||t.job_status==="running"?"Processing...":"Pending...";d.createSpan({text:u,cls:"episode-processing"})}else(t.job_status==="failed"||t.job_status==="error")&&d.createSpan({text:"Generation failed",cls:"episode-error"});d.createEl("button",{text:"\u{1F5D1} Delete",cls:"mod-warning podcast-action-button"}).addEventListener("click",()=>this.deleteEpisode(t))}async generatePodcast(){if(!this.selectedEpisodeProfile||!this.selectedSpeakerProfile){c.error("Please select both episode and speaker profiles");return}let{PodcastGenerationModal:e}=(Ne(),ue(Pe)),t=new e(this.app);t.open(),this.isGenerating=!0;try{let n=await this.plugin.getAPIClient().generatePodcast({episode_profile:this.selectedEpisodeProfile,speaker_profile:this.selectedSpeakerProfile,episode_name:`${this.notebookName} Podcast - ${new Date().toLocaleDateString()}`,notebook_id:this.notebookId});i.info("Podcast generation started:",n),t.setSuccess("Podcast generation started! This may take a few minutes.",5e3),setTimeout(()=>{this.close()},5e3),await this.loadEpisodes(),this.refresh()}catch(o){i.error("Failed to generate podcast",o),t.setError(o.message||"Failed to generate podcast")}finally{this.isGenerating=!1}}async playEpisode(e){try{this.currentAudio&&(this.currentAudio.pause(),this.currentAudio=null),i.info("Playing podcast episode:",e.id);let t=c.loading("Loading audio..."),n=await this.plugin.getAPIClient().downloadPodcastAudio(e.id);c.hideNotice(t);let r=new Blob([n],{type:"audio/mpeg"}),a=URL.createObjectURL(r);this.currentAudio=new Audio(a),this.currentAudio.play();let l=new D.Notice("",0),d=l.noticeEl;d.empty(),d.addClass("podcast-player-notice");let u=d.createDiv({cls:"podcast-player-controls"});u.createSpan({text:`\u25B6 Playing: ${e.name}`}),u.createEl("button",{text:"Stop",cls:"mod-warning"}).addEventListener("click",()=>{this.currentAudio&&(this.currentAudio.pause(),this.currentAudio=null),l.hide()}),this.currentAudio.addEventListener("ended",()=>{l.hide(),this.currentAudio=null})}catch(t){i.error("Failed to play podcast",t),c.error("Failed to play podcast")}}async downloadEpisode(e){try{let t=c.loading("Downloading podcast..."),n=await this.plugin.getAPIClient().downloadPodcastAudio(e.id);c.hideNotice(t);let r=new Blob([n],{type:"audio/mpeg"}),a=URL.createObjectURL(r),l=document.createElement("a");l.href=a,l.download=`${e.name||"podcast"}.mp3`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a),c.success("Podcast downloaded")}catch(t){i.error("Failed to download podcast",t),c.error("Failed to download podcast")}}sanitizeFilename(e){return e.replace(/[\/\\:*?"<>|]/g,"-")}async saveEpisodeAsNote(e){let t=c.loading("Saving podcast note...");try{let o="Generated Podcasts";this.app.vault.getAbstractFileByPath(o)||(await this.app.vault.createFolder(o),i.info(`Created ${o} folder`));let r=this.sanitizeFilename(e.name||"Untitled Episode"),a=`${o}/${r}`,l=0;for(;this.app.vault.getAbstractFileByPath(a);)l++,a=`${o}/${r}_${l}`;await this.app.vault.createFolder(a),i.info(`Created episode folder: ${a}`);let d=`${r}.mp3`,u=`${a}/${d}`,p=`${a}/${r}.md`;try{let g=await this.plugin.getAPIClient().downloadPodcastAudio(e.id),k=await new Blob([g],{type:"audio/mpeg"}).arrayBuffer();await this.app.vault.createBinary(u,k),i.info(`Saved audio file: ${u}`)}catch(m){i.error("Failed to download audio file",m),c.hideNotice(t),c.error("Failed to download audio file");return}let h=`# ${e.name}

**Status:** ${e.job_status||"Unknown"}
**Created:** ${e.created?new Date(e.created).toLocaleString():"Unknown"}
**Notebook:** ${this.notebookName}

## Audio

![[${d}]]

## Briefing

${e.briefing||"No briefing available"}

---

*Generated by Open Notebook*
`;await this.app.vault.create(p,h),c.hideNotice(t),c.success(`Podcast saved: ${p}`),this.close()}catch(o){c.hideNotice(t),i.error("Failed to save episode as note",o),c.error("Failed to create note")}}async deleteEpisode(e){try{if(!confirm(`Are you sure you want to delete "${e.name}"?`))return;await this.plugin.getAPIClient().deletePodcastEpisode(e.id),c.success("Episode deleted"),await this.loadEpisodes(),this.refresh()}catch(t){i.error("Failed to delete episode",t),c.error("Failed to delete episode")}}startStatusPolling(){this.statusCheckInterval=window.setInterval(async()=>{this.episodes.filter(t=>t.job_status==="processing"||t.job_status==="pending"||t.job_status==="running").length!==0&&(await this.loadEpisodes(),this.refresh())},1e4)}refresh(){this.renderEpisodesList(),this.renderGenerateSection()}getStatusText(e){if(!e)return"Unknown";switch(e.toLowerCase()){case"pending":return"Pending";case"processing":return"Processing";case"running":return"Processing";case"completed":return"Completed";case"failed":return"Failed";case"error":return"Error";default:return e}}}});var Ae={};B(Ae,{ConflictModal:()=>be});var Fe,be,xe=F(()=>{Fe=require("obsidian");w();be=class extends Fe.Modal{constructor(e,t,o){super(e);this.conflict=t,this.onResolve=o}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("open-notebook-conflict-modal"),e.createEl("h2",{text:"Sync Conflict Detected"});let t=e.createDiv({cls:"conflict-description"});t.createEl("p",{text:`Both the local and remote versions of "${this.getFileName()}" have been modified.`}),t.createEl("p",{text:"Please choose which version to keep:"});let o=e.createDiv({cls:"conflict-details"}),n=o.createDiv({cls:"conflict-version"});n.createEl("h3",{text:"\u{1F4DD} Local Version (Obsidian)"}),n.createDiv({cls:"conflict-metadata"}).createEl("div",{text:`Modified: ${this.formatDate(this.conflict.localVersion.modifiedAt)}`}),n.createDiv({cls:"conflict-preview"}).createEl("pre").setText(this.truncateContent(this.conflict.localVersion.content));let d=o.createDiv({cls:"conflict-version"});d.createEl("h3",{text:"\u2601\uFE0F Remote Version (Open Notebook)"}),d.createDiv({cls:"conflict-metadata"}).createEl("div",{text:`Modified: ${this.formatDate(this.conflict.remoteVersion.modifiedAt)}`}),d.createDiv({cls:"conflict-preview"}).createEl("pre").setText(this.truncateContent(this.conflict.remoteVersion.content));let m=e.createDiv({cls:"conflict-buttons"});m.createEl("button",{cls:"mod-cta",text:"Keep Local Version"}).addEventListener("click",()=>{i.info("User chose to keep local version"),this.onResolve("local"),this.close()}),m.createEl("button",{cls:"mod-warning",text:"Keep Remote Version"}).addEventListener("click",()=>{i.info("User chose to keep remote version"),this.onResolve("remote"),this.close()}),m.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{i.info("User cancelled conflict resolution"),this.onResolve("cancel"),this.close()}),e.createDiv({cls:"conflict-warning"}).createEl("p",{text:"\u26A0\uFE0F The version you don't choose will be lost. Consider backing up important changes before proceeding."})}onClose(){let{contentEl:e}=this;e.empty()}getFileName(){let e=this.conflict.filePath.split("/");return e[e.length-1]}formatDate(e){return new Date(e).toLocaleString()}truncateContent(e,t=20){let o=e.split(`
`);return o.length<=t?e:o.slice(0,t).join(`
`)+`

... (truncated)`}}});var De={};B(De,{TransformModalWithResult:()=>ve});var ve,$e=F(()=>{ge();U();E();ve=class{constructor(s,e,t){this.app=s,this.plugin=e,this.file=t}async open(){let s=await this.app.vault.read(this.file),e=null;new R(this.app,this.plugin,s,async(t,o)=>{if(!o||!e){c.warn("No transformation information available");return}e.setResult({transformation:o,originalText:s,transformedText:t,context:{type:"file",file:this.file,onRetry:()=>{this.open()}}})},()=>(e=new _(this.app,this.plugin),e.open(),e)).open()}}});var _e={};B(_e,{default:()=>de});module.exports=ue(_e);var S=require("obsidian");var ye={apiEndpoint:"http://localhost:8000",apiPassword:"",connectionStatus:"disconnected",mappingStrategy:"folder",folderToNotebook:{},notebookTagPrefix:"on-notebook/",notebookPropertyName:"notebook",syncMode:"realtime",syncOnSave:!0,syncDebounceMs:2e3,syncIntervalMinutes:5,conflictResolution:"obsidian-wins",syncAttachments:!0,syncOnStartup:!0,enableChat:!0,enableSearch:!0,enableTransformations:!0,enablePodcasts:!1,chatSidebarPosition:"right",defaultSearchMode:"vector",showSyncStatus:!0,showNotifications:!0,enableDebugLogging:!1,requestTimeout:3e4,retryAttempts:3,excludedFolders:["Generated Podcasts"],defaultChatModel:void 0,defaultTransformationModel:void 0,largeContextModel:void 0,autoDeleteFiles:!1,preferredLanguage:"en",mobileOptimized:!0,disableHeavyFeaturesOnMobile:!0,increasedTouchTargets:!0,sourceMappings:{},autoSyncOnSave:!0};var f=require("obsidian");var K=require("obsidian");var G=class{constructor(s){this.password=s}setPassword(s){this.password=s}getAuthHeaders(){return{"x-api-password":this.password}}isConfigured(){return this.password!==null&&this.password!==void 0&&this.password.length>0}validatePassword(s){return s.length>0}};var he=require("obsidian");w();var W=class{async*streamEvents(s,e){i.debug(`Starting SSE stream from: ${s}`);try{let n=(await(0,he.requestUrl)({...e,url:s,headers:{...e.headers,Accept:"text/event-stream","Cache-Control":"no-cache"}})).text.split(`
`),r={};for(let a of n)if(a.startsWith("data: ")){let l=a.slice(6);try{yield JSON.parse(l)}catch(d){l&&l!=="[DONE]"&&(yield{type:"message",data:l})}}else a.startsWith("event: ")?r.event=a.slice(7):a===""&&r.event&&(yield r,r={});i.debug("SSE stream completed")}catch(t){throw i.error("SSE stream error",t),t}}async*streamChatResponse(s,e,t,o,n){i.debug("Streaming chat response");let r={session_id:e,message:t,context:o};console.log("[SSE Debug] Streaming chat to URL:",s),console.log("[SSE Debug] Payload:",r),console.log("[SSE Debug] Headers:",n);try{let a=await(0,he.requestUrl)({url:s,method:"POST",headers:{...n,"Content-Type":"application/json",Accept:"text/event-stream"},body:JSON.stringify(r),throw:!1});if(console.log("[SSE Debug] Response status:",a.status),console.log("[SSE Debug] Response headers:",a.headers),a.status>=400)throw console.error("[SSE Debug] Error response body:",a.text),console.error("[SSE Debug] Error response JSON:",a.json),new Error(`Chat API error ${a.status}: ${JSON.stringify(a.json)}`);let l=a.text;if(console.log("[SSE Debug] Full response text length:",l.length),console.log("[SSE Debug] First 500 chars:",l.substring(0,500)),(a.headers["content-type"]||"").includes("application/json")){console.log("[SSE Debug] Response is JSON, not SSE - parsing as conversation response");try{let h=JSON.parse(l);if(console.log("[SSE Debug] Parsed JSON response:",h),h.messages&&Array.isArray(h.messages)){console.log(`[SSE Debug] Found ${h.messages.length} messages in response`);for(let m=h.messages.length-1;m>=0;m--){let g=h.messages[m];if(g.type==="ai"&&g.content){console.log("[SSE Debug] Found latest AI message:",g),console.log("[SSE Debug] Yielding AI content:",g.content),yield g.content;return}}}console.warn("[SSE Debug] No AI message found in response")}catch(h){console.error("[SSE Debug] Failed to parse JSON response:",h)}return}let u=l.split(`
`);console.log("[SSE Debug] Total lines:",u.length);let p=0;for(let h of u)if(console.log("[SSE Debug] Processing line:",h.substring(0,100)),h.startsWith("data: ")){let m=h.slice(6).trim();if(console.log("[SSE Debug] Extracted data:",m),m&&m!=="[DONE]")try{let g=JSON.parse(m);console.log("[SSE Debug] Parsed JSON:",g),g.content?(p++,console.log(`[SSE Debug] Yielding chunk ${p}:`,g.content),yield g.content):typeof g=="string"?(p++,console.log(`[SSE Debug] Yielding string chunk ${p}:`,g),yield g):console.warn("[SSE Debug] Parsed object has no content field:",g)}catch(g){p++,console.log(`[SSE Debug] Yielding raw data chunk ${p}:`,m),yield m}}console.log(`[SSE Debug] Total chunks yielded: ${p}`)}catch(a){throw console.error("[SSE Debug] Chat stream error:",a),i.error("Chat stream error",a),a}}};w();var $=class extends Error{constructor(e,t,o){super(t);this.statusCode=e;this.message=t;this.endpoint=o;this.name="APIError"}},M=class{constructor(s,e,t=3e4,o=3){this.modelDefaultsCache=null;this.notebooksCache=null;this.transformationsCache=null;this.episodeProfilesCache=null;this.speakerProfilesCache=null;this.CACHE_TTL=5*60*1e3;this.endpoint=s.replace(/\/$/,""),this.authManager=new G(e),this.sseHandler=new W,this.timeout=t,this.retryAttempts=o}setPassword(s){this.authManager.setPassword(s)}setEndpoint(s){this.endpoint=s.replace(/\/$/,"")}setTimeout(s){this.timeout=s}setRetryAttempts(s){this.retryAttempts=s}isCacheValid(s){return s?Date.now()-s.timestamp<s.ttl:!1}clearCache(){this.modelDefaultsCache=null,this.notebooksCache=null,this.transformationsCache=null,this.episodeProfilesCache=null,this.speakerProfilesCache=null,i.debug("All caches cleared")}clearNotebooksCache(){this.notebooksCache=null}clearTransformationsCache(){this.transformationsCache=null}async testConnection(){try{let s=await this.request("/health",{method:"GET"});return i.info("Connection test successful",s),!0}catch(s){return i.error("Connection test failed",s),!1}}async authenticate(){try{return await this.getNotebooks(),i.info("Authentication successful"),!0}catch(s){return i.error("Authentication failed",s),!1}}async getApiVersion(){try{return(await this.request("/health")).version||"unknown"}catch(s){return i.error("Failed to get API version",s),"unknown"}}async getNotebooks(s,e=!1){if(!s&&!e&&this.isCacheValid(this.notebooksCache))return i.debug("Returning cached notebooks"),this.notebooksCache.data;let t=s!==void 0?`?archived=${s}`:"",o=await this.request(`/api/notebooks${t}`);return s||(this.notebooksCache={data:o,timestamp:Date.now(),ttl:this.CACHE_TTL},i.debug(`Cached ${o.length} notebooks`)),o}async getNotebook(s){return this.request(`/api/notebooks/${s}`)}async createNotebook(s){return this.request("/api/notebooks",{method:"POST",body:s})}async updateNotebook(s,e){return this.request(`/api/notebooks/${s}`,{method:"PUT",body:e})}async deleteNotebook(s){await this.request(`/api/notebooks/${s}`,{method:"DELETE"})}async getSources(s){let e=s?`?notebook_id=${s}`:"";return this.request(`/api/sources${e}`)}async getSource(s){return this.request(`/api/sources/${s}`)}async createSource(s){var e;try{return await this.makeRequest("/api/sources/json",{method:"POST",body:s})}catch(t){if(t instanceof $&&t.statusCode===500&&t.message.includes("asyncio.run()")){i.debug("Known backend asyncio bug detected - verifying source creation"),await this.sleep(1e3);let o=(e=s.notebooks)==null?void 0:e[0];if(o){let r=(await this.getSources(o)).filter(a=>a.title===s.title);if(r.length>0){r.sort((l,d)=>{let u=new Date(l.updated||l.created).getTime();return new Date(d.updated||d.created).getTime()-u});let a=r[0];return i.info(`Source created successfully (backend asyncio error ignored): ${a.id}`),a}}throw i.error("Failed to verify source creation after backend error"),t}throw t}}async updateSource(s,e){return this.request(`/api/sources/${s}`,{method:"PUT",body:e})}async deleteSource(s){await this.request(`/api/sources/${s}`,{method:"DELETE"})}async getNotes(s){let e=s?`?notebook_id=${s}`:"";return this.request(`/api/notes${e}`)}async getNote(s){return this.request(`/api/notes/${s}`)}async createNote(s){return this.request("/api/notes",{method:"POST",body:s})}async updateNote(s,e){return this.request(`/api/notes/${s}`,{method:"PUT",body:e})}async deleteNote(s){await this.request(`/api/notes/${s}`,{method:"DELETE"})}async getInsights(s){return this.request(`/api/sources/${s}/insights`)}async getInsight(s){return this.request(`/api/insights/${s}`)}async generateInsight(s,e){return this.request(`/api/sources/${s}/insights`,{method:"POST",body:{transformation_id:e}})}async getTransformations(s=!1){if(!s&&this.isCacheValid(this.transformationsCache))return i.debug("Returning cached transformations"),this.transformationsCache.data;let e=await this.request("/api/transformations/");return this.transformationsCache={data:e,timestamp:Date.now(),ttl:this.CACHE_TTL},i.debug(`Cached ${e.length} transformations`),e}async getModelDefaults(){return this.modelDefaultsCache?this.modelDefaultsCache:(this.modelDefaultsCache=await this.request("/api/models/defaults"),this.modelDefaultsCache)}async getAvailableModels(){try{return await this.request("/api/models")}catch(s){return i.warn("Failed to fetch available models, endpoint may not exist",s),[]}}async executeTransformation(s,e,t){let o;if(t)o=t;else{let a=(await this.getTransformations()).find(l=>l.id===s);if(!a)throw new Error(`Transformation ${s} not found`);a.model?o=a.model:o=(await this.getModelDefaults()).default_transformation_model}let n={transformation_id:s,input_text:e,model_id:o};return this.request("/api/transformations/execute",{method:"POST",body:n})}async deleteInsight(s){await this.request(`/api/insights/${s}`,{method:"DELETE"})}async getChatSessions(s){return this.request(`/api/chat/sessions?notebook_id=${s}`)}async getChatSession(s){return this.request(`/api/chat/sessions/${s}`)}async createChatSession(s){return this.request("/api/chat/sessions",{method:"POST",body:s})}async deleteChatSession(s){await this.request(`/api/chat/sessions/${s}`,{method:"DELETE"})}async getChatMessages(s){return this.request(`/api/chat/sessions/${s}/messages`)}async sendMessage(s,e,t){let o=`${this.endpoint}/api/chat/execute`;i.debug(`Sending chat message to session: ${s}`);try{let n=await(0,K.requestUrl)({url:o,method:"POST",headers:{...this.authManager.getAuthHeaders(),"Content-Type":"application/json"},body:JSON.stringify({session_id:s,message:e,context:t}),throw:!1});if(n.status>=400)throw new Error(`Chat API error ${n.status}: ${JSON.stringify(n.json)}`);return n.json}catch(n){throw i.error("Failed to send chat message",n),n}}async search(s){let e={query:s.query,search_type:s.type,limit:s.limit,search_sources:s.searchSources,search_notes:s.searchNotes};s.minimumScore!==void 0&&(e.minimum_score=s.minimumScore),s.notebookId&&(e.notebook_id=s.notebookId);let t=await this.request("/api/search",{method:"POST",body:e});i.debug("Search API response:",t),i.debug("Search API response type:",typeof t),i.debug("Search API response is array?",Array.isArray(t));let o=[];if(Array.isArray(t))o=t;else if(t&&typeof t=="object")if(Array.isArray(t.results))o=t.results;else if(t.sources||t.notes)o=[...Array.isArray(t.sources)?t.sources:[],...Array.isArray(t.notes)?t.notes:[]];else return i.warn("Unexpected search response format:",t),[];else return i.warn("Search returned non-array, non-object response:",t),[];return i.debug(`Found ${o.length} raw results from API`),o.length>0&&(i.debug("First raw result:",o[0]),i.debug("First result keys:",Object.keys(o[0]))),o.map((n,r)=>{let a=0;n.score!==void 0&&n.score!==null?(a=n.score,i.debug(`Result ${r} has score:`,a)):n.similarity!==void 0?(a=n.similarity,i.debug(`Result ${r} has similarity:`,a)):n.distance!==void 0?(a=Math.max(0,1-n.distance),i.debug(`Result ${r} has distance:`,n.distance,"converted to score:",a)):n.relevance!==void 0?(a=n.relevance,i.debug(`Result ${r} has relevance:`,a)):i.warn(`Result ${r} has no score/similarity/distance/relevance field. Keys:`,Object.keys(n)),a>1&&(i.debug(`Normalizing score from ${a} to ${a/100}`),a=a/100);let l=n.content||n.full_text||n.text||"",d=n.excerpt||l.substring(0,300)||"";i.debug(`Result ${r} content length:`,l.length,"excerpt length:",d.length);let u={id:n.id,type:n.type||(n.asset?"source":"note"),title:n.title||"Untitled",excerpt:d,score:a,highlights:n.highlights,metadata:{notebookId:n.notebook_id,topics:n.topics,created:n.created?new Date(n.created):void 0},content:l};return i.debug(`Transformed result ${r}:`,u),u})}async ask(s,e){let t={query:s};return e&&(t.notebook_id=e),(await this.request("/api/ask",{method:"POST",body:t})).answer}async generatePodcast(s){return this.request("/api/podcasts/generate",{method:"POST",body:s})}async getPodcastStatus(s){return this.request(`/api/podcasts/episodes/${s}`)}async getPodcastEpisodes(){return this.request("/api/podcasts/episodes")}async downloadPodcastAudio(s){let e=`${this.endpoint}/api/podcasts/episodes/${s}/audio`;i.debug(`Downloading podcast audio: ${s}`);try{let t=await(0,K.requestUrl)({url:e,method:"GET",headers:{...this.authManager.getAuthHeaders()},throw:!1});if(t.status>=400)throw new Error(`Failed to download podcast: ${t.status}`);return t.arrayBuffer}catch(t){throw i.error("Failed to download podcast audio",t),t}}async deletePodcastEpisode(s){await this.request(`/api/podcasts/episodes/${s}`,{method:"DELETE"})}async getEpisodeProfiles(s=!1){if(!s&&this.isCacheValid(this.episodeProfilesCache))return i.debug("Returning cached episode profiles"),this.episodeProfilesCache.data;let e=await this.request("/api/episode-profiles");return this.episodeProfilesCache={data:e,timestamp:Date.now(),ttl:this.CACHE_TTL},i.debug(`Cached ${e.length} episode profiles`),e}async getSpeakerProfiles(s=!1){if(!s&&this.isCacheValid(this.speakerProfilesCache))return i.debug("Returning cached speaker profiles"),this.speakerProfilesCache.data;let e=await this.request("/api/speaker-profiles");return this.speakerProfilesCache={data:e,timestamp:Date.now(),ttl:this.CACHE_TTL},i.debug(`Cached ${e.length} speaker profiles`),e}async request(s,e={}){return this.withRetry(()=>this.makeRequest(s,e))}async makeRequest(s,e={}){let t=`${this.endpoint}${s}`,o={"Content-Type":"application/json",...this.authManager.getAuthHeaders(),...e.headers||{}},n={url:t,method:e.method||"GET",headers:o,throw:!1};e.body&&(n.body=JSON.stringify(e.body)),i.debug(`API Request: ${n.method} ${t}`);try{let r=await(0,K.requestUrl)(n);if(i.debug(`API Response: ${r.status}`,r.json),r.status>=200&&r.status<300)return r.status===204||!r.text?void 0:r.json;{let a=r.json,l=this.extractErrorMessage(a);throw new $(r.status,l,s)}}catch(r){throw r instanceof $?r:(i.error("Request failed",r),new $(0,r.message||"Network error",s))}}extractErrorMessage(s){return typeof s.detail=="string"?s.detail:Array.isArray(s.detail)?s.detail.map(e=>e.msg).join(", "):"Unknown error"}async withRetry(s,e=1){try{return await s()}catch(t){if(t instanceof $&&t.statusCode>=400&&t.statusCode<500||e>=this.retryAttempts)throw t;let o=Math.min(1e3*Math.pow(2,e-1),1e4);return i.debug(`Retrying request (attempt ${e+1}) after ${o}ms`),await this.sleep(o),this.withRetry(s,e+1)}}sleep(s){return new Promise(e=>setTimeout(e,s))}};w();var O=class{constructor(s){this.client=s;this.features=this.getDefaultFeatures()}getDefaultFeatures(){let s=Date.now();return{["notebooks"]:{available:!1,lastChecked:s},["sources"]:{available:!1,lastChecked:s},["notes"]:{available:!1,lastChecked:s},["chat"]:{available:!1,lastChecked:s},["search"]:{available:!1,lastChecked:s},["transformations"]:{available:!1,lastChecked:s},["podcasts"]:{available:!1,lastChecked:s},["insights"]:{available:!1,lastChecked:s},["episode_profiles"]:{available:!1,lastChecked:s},["speaker_profiles"]:{available:!1,lastChecked:s},lastDetection:s}}async detectFeatures(){i.info("Starting feature detection...");let s=Date.now();try{let e=await this.detectApiVersion();return this.features.apiVersion=e,this.features.lastDetection=s,await Promise.all([this.detectNotebooks(),this.detectSources(),this.detectNotes(),this.detectChat(),this.detectSearch(),this.detectTransformations(),this.detectPodcasts(),this.detectInsights(),this.detectEpisodeProfiles(),this.detectSpeakerProfiles()]),i.info("Feature detection complete",this.getAvailableFeaturesList()),this.features}catch(e){return i.error("Feature detection failed",e),this.features}}async detectApiVersion(){try{let s=await this.client.getApiVersion();return i.debug(`API version: ${s}`),s}catch(s){i.warn("Could not detect API version",s);return}}async detectNotebooks(){try{await this.client.getNotebooks(),this.features["notebooks"]={available:!0,lastChecked:Date.now()},i.debug("Notebooks feature: available")}catch(s){this.features["notebooks"]={available:!1,lastChecked:Date.now()},i.debug("Notebooks feature: unavailable")}}async detectSources(){try{await this.client.getSources(),this.features["sources"]={available:!0,lastChecked:Date.now()},i.debug("Sources feature: available")}catch(s){this.features["sources"]={available:!1,lastChecked:Date.now()},i.debug("Sources feature: unavailable")}}async detectNotes(){try{await this.client.getNotes(),this.features["notes"]={available:!0,lastChecked:Date.now()},i.debug("Notes feature: available")}catch(s){this.features["notes"]={available:!1,lastChecked:Date.now()},i.debug("Notes feature: unavailable")}}async detectChat(){try{await this.client.getChatSessions("test"),this.features["chat"]={available:!0,lastChecked:Date.now()},i.debug("Chat feature: available")}catch(s){this.features["chat"]={available:!0,lastChecked:Date.now()},i.debug("Chat feature: available (endpoint exists, got expected error for test ID)")}}async detectSearch(){try{await this.client.search({query:"test",type:"text",limit:1,searchSources:!0,searchNotes:!1}),this.features["search"]={available:!0,lastChecked:Date.now()},i.debug("Search feature: available")}catch(s){this.features["search"]={available:!1,lastChecked:Date.now()},i.debug("Search feature: unavailable")}}async detectTransformations(){try{await this.client.getTransformations(),this.features["transformations"]={available:!0,lastChecked:Date.now()},i.debug("Transformations feature: available")}catch(s){this.features["transformations"]={available:!1,lastChecked:Date.now()},i.debug("Transformations feature: unavailable")}}async detectPodcasts(){try{await this.client.getPodcastEpisodes(),this.features["podcasts"]={available:!0,lastChecked:Date.now()},i.debug("Podcasts feature: available")}catch(s){this.features["podcasts"]={available:!1,lastChecked:Date.now()},i.debug("Podcasts feature: unavailable")}}async detectInsights(){try{await this.client.getInsights("test"),this.features["insights"]={available:!0,lastChecked:Date.now()},i.debug("Insights feature: available")}catch(s){this.features["insights"]={available:!0,lastChecked:Date.now()},i.debug("Insights feature: available (endpoint exists, got expected error for test ID)")}}async detectEpisodeProfiles(){try{await this.client.getEpisodeProfiles(),this.features["episode_profiles"]={available:!0,lastChecked:Date.now()},i.debug("Episode profiles feature: available")}catch(s){this.features["episode_profiles"]={available:!1,lastChecked:Date.now()},i.debug("Episode profiles feature: unavailable")}}async detectSpeakerProfiles(){try{await this.client.getSpeakerProfiles(),this.features["speaker_profiles"]={available:!0,lastChecked:Date.now()},i.debug("Speaker profiles feature: available")}catch(s){this.features["speaker_profiles"]={available:!1,lastChecked:Date.now()},i.debug("Speaker profiles feature: unavailable")}}hasFeature(s){var e,t;return(t=(e=this.features[s])==null?void 0:e.available)!=null?t:!1}getFeatures(){return this.features}getAvailableFeaturesList(){return Object.entries(this.features).filter(([s,e])=>s!=="apiVersion"&&s!=="lastDetection"&&e.available).map(([s])=>s)}getUnavailableFeaturesList(){return Object.entries(this.features).filter(([s,e])=>s!=="apiVersion"&&s!=="lastDetection"&&!e.available).map(([s])=>s)}static getFeatureName(s){return{["notebooks"]:"Notebooks",["sources"]:"Sources",["notes"]:"Notes",["chat"]:"AI Chat",["search"]:"Search",["transformations"]:"Transformations",["podcasts"]:"Podcast Generation",["insights"]:"Insights",["episode_profiles"]:"Episode Profiles",["speaker_profiles"]:"Speaker Profiles"}[s]}loadFeatures(s){this.features=s}needsRedetection(){if(!this.features.lastDetection)return!0;let s=60*60*1e3;return Date.now()-this.features.lastDetection>s}};w();E();var Y=class extends f.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Open Notebook Settings"}),this.addConnectionSettings(e),this.addMappingSettings(e),this.addSyncSettings(e),this.addFeatureSettings(e),this.addUISettings(e),this.addAdvancedSettings(e)}addConnectionSettings(e){e.createEl("h3",{text:"Connection"}),new f.Setting(e).setName("API Endpoint").setDesc("URL of your Open Notebook instance (e.g., http://localhost:8000)").addText(o=>o.setPlaceholder("http://localhost:8000").setValue(this.plugin.settings.apiEndpoint).onChange(async n=>{this.plugin.settings.apiEndpoint=n.trim(),await this.plugin.saveSettings()})),new f.Setting(e).setName("API Password").setDesc("Password configured in your Open Notebook instance").addText(o=>{o.setPlaceholder("Enter password").setValue(this.plugin.settings.apiPassword).onChange(async n=>{this.plugin.settings.apiPassword=n,await this.plugin.saveSettings()}),o.inputEl.type="password"}),new f.Setting(e).setName("Test Connection").setDesc("Verify connection to Open Notebook API").addButton(o=>o.setButtonText("Test Connection").setCta().onClick(async()=>{await this.testConnection()}));let t=new f.Setting(e).setName("Connection Status").setDesc("Current connection status");this.updateConnectionStatusDisplay(t),this.plugin.settings.detectedFeatures&&this.plugin.settings.connectionStatus==="connected"&&this.addDetectedFeaturesDisplay(e)}updateConnectionStatusDisplay(e){let t=this.plugin.settings.connectionStatus,o=t==="connected"?"\u2713 Connected":t==="error"?"\u2717 Error":"\u25CB Disconnected",n=t==="connected"?"mod-success":t==="error"?"mod-warning":"";e.controlEl.empty();let r=e.controlEl.createDiv({cls:n});if(r.setText(o),this.plugin.settings.lastConnectionCheck){let a=new Date(this.plugin.settings.lastConnectionCheck);r.createEl("div",{text:`Last checked: ${a.toLocaleString()}`,cls:"setting-item-description"})}}addDetectedFeaturesDisplay(e){let t=this.plugin.settings.detectedFeatures;if(!t)return;let o=this.plugin.getFeatureDetector(),n=o.getAvailableFeaturesList(),r=o.getUnavailableFeaturesList(),a=e.createDiv({cls:"setting-item"});a.style.borderTop="1px solid var(--background-modifier-border)",a.style.paddingTop="1em",a.style.marginTop="1em",a.createEl("div",{text:"Detected API Features",cls:"setting-item-name"});let l=a.createEl("div",{cls:"setting-item-description"});if(t.apiVersion&&l.createEl("div",{text:`API Version: ${t.apiVersion}`}),t.lastDetection){let d=new Date(t.lastDetection);l.createEl("div",{text:`Last detected: ${d.toLocaleString()}`,cls:"setting-item-description"})}if(n.length>0){let d=a.createDiv({cls:"detected-features"});d.style.marginTop="0.5em",d.createEl("div",{text:"\u2713 Available Features:",cls:"mod-success"});let u=d.createDiv();u.style.paddingLeft="1.5em",u.style.marginTop="0.3em",n.forEach(p=>{let h=u.createEl("div");h.style.fontSize="0.9em",h.style.color="var(--text-muted)",h.setText(`\u2022 ${O.getFeatureName(p)}`)})}if(r.length>0){let d=a.createDiv({cls:"detected-features"});d.style.marginTop="0.5em",d.createEl("div",{text:"\u2717 Unavailable Features:",cls:"mod-warning"});let u=d.createDiv();u.style.paddingLeft="1.5em",u.style.marginTop="0.3em",r.forEach(p=>{let h=u.createEl("div");h.style.fontSize="0.9em",h.style.color="var(--text-muted)",h.style.opacity="0.6",h.setText(`\u2022 ${O.getFeatureName(p)}`)})}}async loadAvailableModels(){let e=c.loading("Loading available models...");try{let o=await new M(this.plugin.settings.apiEndpoint,this.plugin.settings.apiPassword,this.plugin.settings.requestTimeout,this.plugin.settings.retryAttempts).getAvailableModels();if(c.hideNotice(e),o.length===0){c.error("No models found. Your Open Notebook instance may not support model listing.");return}let n=o.map(a=>`**${a.name}** (${a.provider})
ID: \`${a.id}\``+(a.context_length?`
Context: ${a.context_length} tokens`:"")+(a.supports_vision?`
\u2713 Supports vision`:"")+(a.supports_tools?`
\u2713 Supports tools`:"")).join(`

`);new class extends f.Modal{constructor(a){super(a)}onOpen(){let{contentEl:a}=this;a.empty(),a.createEl("h2",{text:"Available Models"});let l=a.createDiv({cls:"markdown-rendered"});l.style.maxHeight="400px",l.style.overflowY="auto",l.style.padding="10px";let d=l.createEl("pre");d.style.whiteSpace="pre-wrap",d.style.fontFamily="monospace",d.style.fontSize="12px",d.textContent=n;let u=a.createEl("p",{text:"Copy the model ID and paste it into the model settings above.",cls:"setting-item-description"});u.style.marginTop="10px"}onClose(){let{contentEl:a}=this;a.empty()}}(this.app).open()}catch(t){c.hideNotice(e),c.error(`Failed to load models: ${t.message}`),i.error("Failed to load models",t)}}async testConnection(){let e=c.loading("Testing connection to Open Notebook...");try{let t=new M(this.plugin.settings.apiEndpoint,this.plugin.settings.apiPassword,this.plugin.settings.requestTimeout,this.plugin.settings.retryAttempts);if(await t.testConnection())if(await t.authenticate()){let r=await t.getApiVersion();this.plugin.settings.apiVersion=r,c.hideNotice(e);let a=c.loading("Detecting API features..."),l=this.plugin.getFeatureDetector(),d=await l.detectFeatures();this.plugin.settings.detectedFeatures=d,await this.plugin.saveSettings(),c.hideNotice(a);let u=l.getAvailableFeaturesList().length;c.success(`Connected! API v${r} - ${u} features available`),this.plugin.setConnectionStatus("connected")}else c.hideNotice(e),c.error("Connection succeeded but authentication failed. Check your password."),this.plugin.setConnectionStatus("error");else c.hideNotice(e),c.error("Connection failed. Check your endpoint URL."),this.plugin.setConnectionStatus("error");this.display()}catch(t){c.hideNotice(e),c.error(`Connection test failed: ${t.message}`),this.plugin.setConnectionStatus("error"),i.error("Connection test error",t),this.display()}}addMappingSettings(e){e.createEl("h3",{text:"Notebook Mapping"});let t=e.createDiv({cls:"setting-item-description"});t.style.marginBottom="1em",t.style.opacity="0.8",t.setText("\u{1F4A1} Tip: Right-click any folder in your vault to create or link an Open Notebook."),new f.Setting(e).setName("Mapping Strategy").setDesc("How to map Obsidian files to Open Notebook notebooks").addDropdown(o=>o.addOption("folder","By Folder").addOption("tag","By Tag").addOption("property","By Property").setValue(this.plugin.settings.mappingStrategy).onChange(async n=>{this.plugin.settings.mappingStrategy=n,await this.plugin.saveSettings()})),this.plugin.settings.mappingStrategy==="tag"&&new f.Setting(e).setName("Notebook Tag Prefix").setDesc('Prefix for notebook tags (e.g., "on-notebook/" for tags like #on-notebook/research)').addText(o=>o.setPlaceholder("on-notebook/").setValue(this.plugin.settings.notebookTagPrefix).onChange(async n=>{this.plugin.settings.notebookTagPrefix=n,await this.plugin.saveSettings()})),this.plugin.settings.mappingStrategy==="property"&&new f.Setting(e).setName("Notebook Property Name").setDesc('Frontmatter property name for notebook (e.g., "notebook")').addText(o=>o.setPlaceholder("notebook").setValue(this.plugin.settings.notebookPropertyName).onChange(async n=>{this.plugin.settings.notebookPropertyName=n,await this.plugin.saveSettings()}))}addSyncSettings(e){e.createEl("h3",{text:"Synchronization"}),new f.Setting(e).setName("Sync Mode").setDesc("When to synchronize notes with Open Notebook").addDropdown(n=>n.addOption("realtime","Real-time (on save)").addOption("manual","Manual only").addOption("interval","Interval-based").setValue(this.plugin.settings.syncMode).onChange(async r=>{this.plugin.settings.syncMode=r,await this.plugin.saveSettings(),this.display()})),this.plugin.settings.syncMode==="realtime"&&new f.Setting(e).setName("Debounce Duration").setDesc("Wait time (ms) after editing before syncing (prevents excessive API calls)").addText(n=>n.setPlaceholder("2000").setValue(String(this.plugin.settings.syncDebounceMs)).onChange(async r=>{let a=parseInt(r);!isNaN(a)&&a>=0&&(this.plugin.settings.syncDebounceMs=a,await this.plugin.saveSettings())})),this.plugin.settings.syncMode==="interval"&&new f.Setting(e).setName("Sync Interval").setDesc("Minutes between automatic syncs").addText(n=>n.setPlaceholder("5").setValue(String(this.plugin.settings.syncIntervalMinutes)).onChange(async r=>{let a=parseInt(r);!isNaN(a)&&a>0&&(this.plugin.settings.syncIntervalMinutes=a,await this.plugin.saveSettings())})),new f.Setting(e).setName("Conflict Resolution").setDesc("What to do when both local and remote versions have changed").addDropdown(n=>n.addOption("obsidian-wins","Obsidian Wins").addOption("server-wins","Server Wins").addOption("ask-user","Ask Me").setValue(this.plugin.settings.conflictResolution).onChange(async r=>{this.plugin.settings.conflictResolution=r,await this.plugin.saveSettings()})),new f.Setting(e).setName("Sync on Startup").setDesc("Verify and reconcile sync state when Obsidian starts (recommended)").addToggle(n=>n.setValue(this.plugin.settings.syncOnStartup).onChange(async r=>{this.plugin.settings.syncOnStartup=r,await this.plugin.saveSettings()}));let t=this.plugin.settings.sourceMappings||{},o=Object.keys(t).length;o>0&&new f.Setting(e).setName("Sync Statistics").setDesc(`Currently tracking ${o} synced file${o===1?"":"s"}`)}addFeatureSettings(e){e.createEl("h3",{text:"Features"}),new f.Setting(e).setName("Enable Chat").setDesc("Enable AI chat integration").addToggle(t=>t.setValue(this.plugin.settings.enableChat).onChange(async o=>{this.plugin.settings.enableChat=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Enable Search").setDesc("Enable semantic search integration").addToggle(t=>t.setValue(this.plugin.settings.enableSearch).onChange(async o=>{this.plugin.settings.enableSearch=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Enable Transformations").setDesc("Enable text transformations (summarize, expand, etc.)").addToggle(t=>t.setValue(this.plugin.settings.enableTransformations).onChange(async o=>{this.plugin.settings.enableTransformations=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Enable Podcasts").setDesc("Enable podcast generation (experimental)").addToggle(t=>t.setValue(this.plugin.settings.enablePodcasts).onChange(async o=>{this.plugin.settings.enablePodcasts=o,await this.plugin.saveSettings()}))}addUISettings(e){e.createEl("h3",{text:"User Interface"}),new f.Setting(e).setName("Chat Sidebar Position").setDesc("Where to show the chat sidebar").addDropdown(t=>t.addOption("left","Left").addOption("right","Right").setValue(this.plugin.settings.chatSidebarPosition).onChange(async o=>{this.plugin.settings.chatSidebarPosition=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Default Search Mode").setDesc("Default search type when opening search").addDropdown(t=>t.addOption("text","Text Search").addOption("vector","Vector Search (Semantic)").setValue(this.plugin.settings.defaultSearchMode).onChange(async o=>{this.plugin.settings.defaultSearchMode=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Show Sync Status").setDesc("Show sync status in status bar").addToggle(t=>t.setValue(this.plugin.settings.showSyncStatus).onChange(async o=>{this.plugin.settings.showSyncStatus=o,await this.plugin.saveSettings()})),new f.Setting(e).setName("Show Notifications").setDesc("Show notifications for sync and other operations").addToggle(t=>t.setValue(this.plugin.settings.showNotifications).onChange(async o=>{this.plugin.settings.showNotifications=o,await this.plugin.saveSettings()}))}addAdvancedSettings(e){e.createEl("h3",{text:"Advanced"});let t=e.createDiv({cls:"setting-item-heading"});t.createEl("h4",{text:"Model Selection"}),t.createEl("p",{text:"Override default models for different operations. Leave empty to use API defaults.",cls:"setting-item-description"}),new f.Setting(e).setName("Default Chat Model").setDesc("Model to use for chat conversations. Leave empty to use API default.").addText(a=>a.setPlaceholder("e.g., gpt-4, claude-3-opus-20240229").setValue(this.plugin.settings.defaultChatModel||"").onChange(async l=>{this.plugin.settings.defaultChatModel=l||void 0,await this.plugin.saveSettings()})),new f.Setting(e).setName("Default Transformation Model").setDesc("Model to use for text transformations. Leave empty to use API default.").addText(a=>a.setPlaceholder("e.g., gpt-4-turbo, claude-3-sonnet-20240229").setValue(this.plugin.settings.defaultTransformationModel||"").onChange(async l=>{this.plugin.settings.defaultTransformationModel=l||void 0,await this.plugin.saveSettings()})),new f.Setting(e).setName("Large Context Model").setDesc("Model to use for operations requiring large context windows. Leave empty to use API default.").addText(a=>a.setPlaceholder("e.g., gpt-4-32k, claude-3-opus-20240229").setValue(this.plugin.settings.largeContextModel||"").onChange(async l=>{this.plugin.settings.largeContextModel=l||void 0,await this.plugin.saveSettings()})),new f.Setting(e).setName("Available Models").setDesc("Fetch and display models available from your Open Notebook instance").addButton(a=>a.setButtonText("Load Models").onClick(async()=>{await this.loadAvailableModels()})),e.createDiv({cls:"setting-item-heading"}).createEl("h4",{text:"Processing Options"}),new f.Setting(e).setName("Auto-delete Source Files").setDesc("Automatically delete uploaded files after processing (PDF, videos, etc.)").addToggle(a=>a.setValue(this.plugin.settings.autoDeleteFiles).onChange(async l=>{this.plugin.settings.autoDeleteFiles=l,await this.plugin.saveSettings()})),new f.Setting(e).setName("Preferred Language").setDesc("Language preference for AI responses and transformations").addDropdown(a=>a.addOption("en","English").addOption("es","Spanish").addOption("fr","French").addOption("de","German").addOption("it","Italian").addOption("pt","Portuguese").addOption("ja","Japanese").addOption("ko","Korean").addOption("zh","Chinese").setValue(this.plugin.settings.preferredLanguage).onChange(async l=>{this.plugin.settings.preferredLanguage=l,await this.plugin.saveSettings()}));let n=e.createDiv({cls:"setting-item-heading"});n.createEl("h4",{text:"Mobile Optimization"}),n.createEl("p",{text:"Settings to optimize plugin performance and usability on mobile devices.",cls:"setting-item-description"}),new f.Setting(e).setName("Mobile Optimizations").setDesc("Enable automatic mobile-specific optimizations (longer cache, reduced animations)").addToggle(a=>a.setValue(this.plugin.settings.mobileOptimized).onChange(async l=>{this.plugin.settings.mobileOptimized=l,await this.plugin.saveSettings()})),new f.Setting(e).setName("Disable Heavy Features on Mobile").setDesc("Automatically disable resource-intensive features when running on mobile devices").addToggle(a=>a.setValue(this.plugin.settings.disableHeavyFeaturesOnMobile).onChange(async l=>{this.plugin.settings.disableHeavyFeaturesOnMobile=l,await this.plugin.saveSettings()})),new f.Setting(e).setName("Increased Touch Targets").setDesc("Make buttons and interactive elements larger for easier touch interaction").addToggle(a=>a.setValue(this.plugin.settings.increasedTouchTargets).onChange(async l=>{this.plugin.settings.increasedTouchTargets=l,await this.plugin.saveSettings()})),e.createDiv({cls:"setting-item-heading"}).createEl("h4",{text:"System"}),new f.Setting(e).setName("Enable Debug Logging").setDesc("Show detailed debug logs in console (for troubleshooting)").addToggle(a=>a.setValue(this.plugin.settings.enableDebugLogging).onChange(async l=>{this.plugin.settings.enableDebugLogging=l,await this.plugin.saveSettings()})),new f.Setting(e).setName("Request Timeout").setDesc("API request timeout in milliseconds").addText(a=>a.setPlaceholder("30000").setValue(String(this.plugin.settings.requestTimeout)).onChange(async l=>{let d=parseInt(l);!isNaN(d)&&d>0&&(this.plugin.settings.requestTimeout=d,await this.plugin.saveSettings())})),new f.Setting(e).setName("Retry Attempts").setDesc("Number of times to retry failed API requests").addText(a=>a.setPlaceholder("3").setValue(String(this.plugin.settings.retryAttempts)).onChange(async l=>{let d=parseInt(l);!isNaN(d)&&d>=0&&(this.plugin.settings.retryAttempts=d,await this.plugin.saveSettings())})),new f.Setting(e).setName("Excluded Folders").setDesc('Folders that should not be synced to Open Notebook (one per line). "Generated Podcasts" is excluded by default.').addTextArea(a=>{a.setPlaceholder(`Generated Podcasts
Archive
Templates`).setValue((this.plugin.settings.excludedFolders||[]).join(`
`)).onChange(async l=>{this.plugin.settings.excludedFolders=l.split(`
`).map(d=>d.trim()).filter(d=>d.length>0),await this.plugin.saveSettings()}),a.inputEl.rows=4,a.inputEl.cols=40}),this.plugin.settings.apiVersion&&new f.Setting(e).setName("API Version").setDesc(`Connected to Open Notebook API version: ${this.plugin.settings.apiVersion}`)}};var C=class{static fromAPI(s,e){return{id:s.id,name:s.name,description:s.description,archived:s.archived,created:new Date(s.created),updated:new Date(s.updated),sourceCount:s.source_count,noteCount:s.note_count,localPath:e,syncEnabled:!0,lastSynced:void 0}}static fromAPIList(s,e){return s.map(t=>{let o=e?Object.keys(e).find(n=>e[n]===t.id):void 0;return C.fromAPI(t,o)})}static toAPICreate(s,e){return{name:s,description:e||""}}static toAPIUpdate(s){return{name:s.name,description:s.description,archived:s.archived}}};w();var J=class{constructor(s,e){this.notebookCache=new Map;this.lastCacheUpdate=0;this.CACHE_TTL=6e4;this.client=s,this.settings=e}async mapFolderToNotebook(s,e){i.info(`Mapping folder "${s}" to notebook "${e}"`);let t=this.normalizePath(s);this.settings.folderToNotebook[t]=e;let o=this.notebookCache.get(e);o&&(o.localPath=t)}async unmapFolder(s){let e=this.normalizePath(s),t=this.settings.folderToNotebook[e];if(t){i.info(`Unmapping folder "${s}" from notebook "${t}"`);let o=this.notebookCache.get(t);o&&(o.localPath=void 0),delete this.settings.folderToNotebook[e]}}getNotebookForFolder(s){let e=this.normalizePath(s);return this.settings.folderToNotebook[e]}getFolderForNotebook(s){return Object.keys(this.settings.folderToNotebook).find(e=>this.settings.folderToNotebook[e]===s)}getAllMappings(){return{...this.settings.folderToNotebook}}async getNotebooks(s=!1){let e=Date.now();if(!s&&e-this.lastCacheUpdate<this.CACHE_TTL)return i.debug("Returning cached notebooks"),Array.from(this.notebookCache.values());i.debug("Fetching notebooks from API");let t=await this.client.getNotebooks(),o=C.fromAPIList(t,this.settings.folderToNotebook);return this.notebookCache.clear(),o.forEach(n=>{this.notebookCache.set(n.id,n)}),this.lastCacheUpdate=e,o}async getNotebook(s,e=!0){if(e&&this.notebookCache.has(s))return i.debug(`Returning cached notebook: ${s}`),this.notebookCache.get(s);try{let t=await this.client.getNotebook(s),o=this.getFolderForNotebook(s),n=C.fromAPI(t,o);return this.notebookCache.set(s,n),n}catch(t){return i.error(`Failed to fetch notebook ${s}`,t),null}}async createNotebook(s){i.info(`Creating notebook: ${s.name}`);let e=C.toAPICreate(s.name,s.description),t=await this.client.createNotebook(e),o=C.fromAPI(t);return this.notebookCache.set(o.id,o),o}async createNotebookFromFolder(s){let e=s.name||s.path.split("/").pop()||"Unnamed";i.info(`Creating notebook from folder: ${s.path}`);let t=await this.createNotebook({name:e,description:`Synced from Obsidian folder: ${s.path}`});return await this.mapFolderToNotebook(s.path,t.id),t}async updateNotebook(s,e){i.info(`Updating notebook: ${s}`);try{let t=C.toAPIUpdate(e),o=await this.client.updateNotebook(s,t),n=this.getFolderForNotebook(s),r=C.fromAPI(o,n);return this.notebookCache.set(s,r),r}catch(t){return i.error(`Failed to update notebook ${s}`,t),null}}async deleteNotebook(s){i.info(`Deleting notebook: ${s}`);try{await this.client.deleteNotebook(s),this.notebookCache.delete(s);let e=this.getFolderForNotebook(s);return e&&await this.unmapFolder(e),!0}catch(e){return i.error(`Failed to delete notebook ${s}`,e),!1}}async getOrCreateNotebook(s){let e=this.normalizePath(s),t=this.getNotebookForFolder(e);if(t)return i.debug(`Folder "${s}" already mapped to notebook: ${t}`),t;let o=e.split("/").pop()||"Unnamed",n=await this.createNotebook({name:o,description:`Synced from Obsidian folder: ${e}`});return await this.mapFolderToNotebook(e,n.id),n.id}async validateMapping(s){let e=this.getNotebookForFolder(s);return e?await this.getNotebook(e,!1)?!0:(i.warn(`Notebook ${e} not found, removing invalid mapping`),await this.unmapFolder(s),!1):(i.debug(`No mapping found for folder: ${s}`),!1)}clearCache(){i.debug("Clearing notebook cache"),this.notebookCache.clear(),this.lastCacheUpdate=0}normalizePath(s){return s.replace(/^\/+|\/+$/g,"")}getMappedNotebooks(){return Array.from(this.notebookCache.values()).filter(s=>s.localPath!==void 0)}getUnmappedNotebooks(){return Array.from(this.notebookCache.values()).filter(s=>s.localPath===void 0)}};var q=require("obsidian"),Z=class extends q.Modal{constructor(e,t,o){super(e);this.name="";this.description="";this.onSubmit=t,o&&(this.name=o)}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Create Notebook"}),new q.Setting(e).setName("Notebook Name").setDesc("Name for the new notebook").addText(t=>t.setPlaceholder("My Research Notebook").setValue(this.name).onChange(o=>{this.name=o})),new q.Setting(e).setName("Description").setDesc("Optional description").addTextArea(t=>{t.setPlaceholder("A collection of research notes...").setValue(this.description).onChange(o=>{this.description=o}),t.inputEl.rows=4,t.inputEl.style.width="100%"}),new q.Setting(e).addButton(t=>t.setButtonText("Cancel").onClick(()=>{this.close()})).addButton(t=>t.setButtonText("Create").setCta().onClick(()=>{this.name.trim()&&(this.onSubmit({name:this.name.trim(),description:this.description.trim()||void 0}),this.close())}))}onClose(){let{contentEl:e}=this;e.empty()}};var j=require("obsidian"),X=class extends j.Modal{constructor(e,t,o,n){super(e);this.selectedNotebookId=null;this.folderPath=t,this.notebooks=o,this.onSubmit=n}onOpen(){let{contentEl:e}=this;e.createEl("h2",{text:"Link Folder to Notebook"}),e.createEl("p",{text:`Select a notebook to link with folder: ${this.folderPath}`}),new j.Setting(e).setName("Notebook").setDesc("Choose an existing notebook").addDropdown(o=>{o.addOption("","-- Select Notebook --"),this.notebooks.forEach(n=>{let r=n.localPath?`${n.name} (already mapped to ${n.localPath})`:n.name;o.addOption(n.id,r)}),o.onChange(n=>{this.selectedNotebookId=n})});let t=this.notebooks.filter(o=>!o.localPath).length;e.createEl("p",{text:`${t} unmapped notebook(s) available`,cls:"setting-item-description"}),new j.Setting(e).addButton(o=>o.setButtonText("Cancel").onClick(()=>{this.close()})).addButton(o=>o.setButtonText("Link").setCta().onClick(()=>{this.selectedNotebookId&&(this.onSubmit(this.selectedNotebookId),this.close())}))}onClose(){let{contentEl:e}=this;e.empty()}};E();w();var ee=class{constructor(s,e,t){this.app=s,this.plugin=e,this.notebookManager=t}registerCommands(){this.plugin.addCommand({id:"list-notebooks",name:"List All Notebooks",callback:async()=>{await this.listNotebooks()}}),this.plugin.addCommand({id:"create-notebook-from-folder",name:"Create Notebook from Folder",callback:async()=>{let s=this.app.workspace.getActiveFile();s&&s.parent?await this.createNotebookFromFolder(s.parent):c.warn("No active file. Open a file in the folder you want to link.")}}),this.plugin.addCommand({id:"link-folder-to-notebook",name:"Link Folder to Notebook",callback:async()=>{let s=this.app.workspace.getActiveFile();s&&s.parent?await this.linkFolderToNotebook(s.parent):c.warn("No active file. Open a file in the folder you want to link.")}}),this.plugin.addCommand({id:"unlink-folder",name:"Unlink Folder from Notebook",callback:async()=>{let s=this.app.workspace.getActiveFile();s&&s.parent?this.notebookManager.getNotebookForFolder(s.parent.path)?await this.unlinkFolder(s.parent):c.warn("Current folder is not linked to any notebook."):c.warn("No active file. Open a file in the folder you want to unlink.")}}),this.plugin.addCommand({id:"refresh-notebooks",name:"Refresh Notebook List",callback:async()=>{await this.refreshNotebooks()}}),this.plugin.addCommand({id:"show-mappings",name:"Show Folder Mappings",callback:()=>{this.showMappings()}})}async listNotebooks(){let s=c.loading("Loading notebooks...");try{let e=await this.notebookManager.getNotebooks(!0);if(c.hideNotice(s),e.length===0){c.info("No notebooks found");return}let t=e.filter(r=>r.localPath),o=e.filter(r=>!r.localPath),n=`\u{1F4DA} Total Notebooks: ${e.length}

`;t.length>0&&(n+=`\u2713 Mapped (${t.length}):
`,t.forEach(r=>{n+=`  \u2022 ${r.name} \u2192 ${r.localPath}
`}),n+=`
`),o.length>0&&(n+=`\u25CB Unmapped (${o.length}):
`,o.forEach(r=>{n+=`  \u2022 ${r.name} (${r.sourceCount} sources, ${r.noteCount} notes)
`})),console.log(n),c.info(`Found ${e.length} notebook(s). Check console for details.`)}catch(e){c.hideNotice(s),c.error(`Failed to load notebooks: ${e.message}`),i.error("Failed to list notebooks",e)}}async createNotebookFromFolder(s){let e=s.name||s.path.split("/").pop()||"Unnamed";new Z(this.app,async t=>{let o=c.loading("Creating notebook...");try{let n=await this.notebookManager.createNotebookFromFolder(s);c.hideNotice(o),c.success(`Created notebook "${n.name}" linked to ${s.path}`),await this.plugin.saveSettings()}catch(n){c.hideNotice(o),c.error(`Failed to create notebook: ${n.message}`),i.error("Failed to create notebook from folder",n)}},e).open()}async linkFolderToNotebook(s){if(this.notebookManager.getNotebookForFolder(s.path)){c.warn("Folder is already linked to a notebook. Unlink first if you want to change.");return}let t=c.loading("Loading notebooks...");try{let o=await this.notebookManager.getNotebooks();if(c.hideNotice(t),o.length===0){c.info("No notebooks found. Create one first.");return}new X(this.app,s.path,o,async n=>{let r=c.loading("Linking folder...");try{await this.notebookManager.mapFolderToNotebook(s.path,n),await this.plugin.saveSettings(),c.hideNotice(r);let a=await this.notebookManager.getNotebook(n);c.success(`Linked ${s.path} to "${(a==null?void 0:a.name)||n}"`)}catch(a){c.hideNotice(r),c.error(`Failed to link folder: ${a.message}`),i.error("Failed to link folder",a)}}).open()}catch(o){c.hideNotice(t),c.error(`Failed to load notebooks: ${o.message}`),i.error("Failed to load notebooks",o)}}async unlinkFolder(s){let e=this.notebookManager.getNotebookForFolder(s.path);if(!e){c.warn("Folder is not linked to any notebook");return}try{let t=await this.notebookManager.getNotebook(e),o=(t==null?void 0:t.name)||e;await this.notebookManager.unmapFolder(s.path),await this.plugin.saveSettings(),c.success(`Unlinked ${s.path} from "${o}"`)}catch(t){c.error(`Failed to unlink folder: ${t.message}`),i.error("Failed to unlink folder",t)}}async refreshNotebooks(){let s=c.loading("Refreshing notebooks...");try{this.notebookManager.clearCache();let e=await this.notebookManager.getNotebooks(!0);c.hideNotice(s),c.success(`Refreshed ${e.length} notebook(s)`)}catch(e){c.hideNotice(s),c.error(`Failed to refresh notebooks: ${e.message}`),i.error("Failed to refresh notebooks",e)}}showMappings(){let s=this.notebookManager.getAllMappings(),e=Object.keys(s).length;if(e===0){c.info("No folder mappings configured");return}let t=`\u{1F4C1} Folder Mappings (${e}):

`;for(let[o,n]of Object.entries(s))t+=`  ${o} \u2192 ${n}
`;console.log(t),c.info(`${e} folder mapping(s). Check console for details.`)}};ge();U();E();w();var se=class{constructor(s,e){this.BUILTIN_TRANSFORMATIONS={SUMMARIZE:"Simple Summary",DENSE_SUMMARY:"Dense Summary",KEY_INSIGHTS:"Key Insights",ANALYZE_PAPER:"Analyze Paper",REFLECTIONS:"Reflections",TABLE_OF_CONTENTS:"Table of Contents"};this.app=s,this.plugin=e}registerCommands(){this.plugin.addCommand({id:"transform-selection",name:"Transform Selection",editorCallback:(s,e)=>{this.transformSelection(s)}}),this.plugin.addCommand({id:"transform-note",name:"Transform Note",editorCallback:(s,e)=>{this.transformNote(s)}}),this.plugin.addCommand({id:"transform-summarize",name:"Summarize Selection",editorCallback:(s,e)=>{this.transformWithBuiltin(s,this.BUILTIN_TRANSFORMATIONS.SUMMARIZE,!0)}}),this.plugin.addCommand({id:"transform-summarize-note",name:"Summarize Note",editorCallback:(s,e)=>{this.transformWithBuiltin(s,this.BUILTIN_TRANSFORMATIONS.SUMMARIZE,!1)}}),this.plugin.addCommand({id:"transform-key-insights",name:"Extract Key Insights (Selection)",editorCallback:(s,e)=>{this.transformWithBuiltin(s,this.BUILTIN_TRANSFORMATIONS.KEY_INSIGHTS,!0)}}),this.plugin.addCommand({id:"transform-key-insights-note",name:"Extract Key Insights (Note)",editorCallback:(s,e)=>{this.transformWithBuiltin(s,this.BUILTIN_TRANSFORMATIONS.KEY_INSIGHTS,!1)}}),this.plugin.addCommand({id:"transform-analyze-paper",name:"Analyze Paper",editorCallback:(s,e)=>{this.transformWithBuiltin(s,this.BUILTIN_TRANSFORMATIONS.ANALYZE_PAPER,!1)}})}async transformSelection(s){let e=s.getSelection();if(!e||e.trim().length===0){c.warn("Please select some text to transform");return}i.info(`Transforming selection: ${e.length} characters`),new R(this.app,this.plugin,e,t=>{s.replaceSelection(t),i.info("Replaced selection with transformed text")}).open()}async transformNote(s){let e=s.getValue();if(!e||e.trim().length===0){c.warn("Note is empty");return}i.info(`Transforming entire note: ${e.length} characters`),new R(this.app,this.plugin,e,t=>{s.setValue(t),i.info("Replaced note content with transformed text")}).open()}async transformWithBuiltin(s,e,t){let o;if(t){if(o=s.getSelection(),!o||o.trim().length===0){c.warn("Please select some text to transform");return}}else if(o=s.getValue(),!o||o.trim().length===0){c.warn("Note is empty");return}let n=new _(this.app,this.plugin);n.open();try{let r=this.plugin.getAPIClient(),l=(await r.getTransformations()).find(p=>p.id===e||p.name.toLowerCase()===e.toLowerCase().replace("_"," "));if(!l){n.setError(`Transformation "${e}" not found. Please check your Open Notebook configuration.`),i.warn(`Built-in transformation not found: ${e}`);return}i.info(`Executing transformation: ${l.name} on ${o.length} characters`);let d=this.plugin.settings.defaultTransformationModel,u=await r.executeTransformation(l.id,o,d);i.info("Transformation complete:",l.id),n.setResult({transformation:l,originalText:o,transformedText:u.output,context:{type:t?"selection":"note",onAccept:p=>{t?s.replaceSelection(p):s.setValue(p)},onRetry:()=>{this.transformWithBuiltin(s,e,t)}}})}catch(r){i.error("Failed to execute transformation",r),n.setError(r.message||"Unknown error occurred during transformation")}}setupContextMenu(){this.plugin.registerEvent(this.app.workspace.on("editor-menu",(s,e,t)=>{let o=e.getSelection();o&&o.trim().length>0&&(s.addSeparator(),s.addItem(n=>{n.setTitle("Transform Selection").setIcon("wand-glyph").onClick(()=>{this.transformSelection(e)})}),s.addItem(n=>{n.setTitle("Summarize").setIcon("list-collapse").onClick(()=>{this.transformWithBuiltin(e,this.BUILTIN_TRANSFORMATIONS.SUMMARIZE,!0)})}),s.addItem(n=>{n.setTitle("Key Insights").setIcon("lightbulb").onClick(()=>{this.transformWithBuiltin(e,this.BUILTIN_TRANSFORMATIONS.KEY_INSIGHTS,!0)})}))})),i.info("Context menu for transformations registered")}};var H=require("obsidian");w();E();w();var oe=class{constructor(s){this.app=s}async getMetadata(s){try{let e=this.app.metadataCache.getFileCache(s),t=(e==null?void 0:e.frontmatter)||{};return{on_notebook_id:t.on_notebook_id,on_note_id:t.on_note_id,on_source_id:t.on_source_id,on_synced_at:t.on_synced_at,on_modified_at:t.on_modified_at,on_checksum:t.on_checksum,on_sync_enabled:t.on_sync_enabled!==!1,on_topics:t.on_topics,on_ai_generated:t.on_ai_generated}}catch(e){return i.error(`Failed to get metadata for ${s.path}`,e),{}}}async updateMetadata(s,e){try{let t=await this.app.vault.read(s),o=this.updateFrontmatter(t,e);await this.app.vault.modify(s,o),i.debug(`Updated metadata for ${s.path}`,e)}catch(t){throw i.error(`Failed to update metadata for ${s.path}`,t),t}}updateFrontmatter(s,e){let t=/^---\n([\s\S]*?)\n---\n/,o=s.match(t),n={},r=s;if(o){let l=o[1];n=this.parseFrontmatter(l),r=s.slice(o[0].length)}Object.entries(e).forEach(([l,d])=>{d!==void 0?n[l]=d:delete n[l]});let a=this.serializeFrontmatter(n);return a?`---
${a}
---
${r}`:r}parseFrontmatter(s){let e={},t=s.split(`
`);for(let o of t){let n=o.indexOf(":");if(n===-1)continue;let r=o.slice(0,n).trim(),a=o.slice(n+1).trim();a==="true"?a=!0:a==="false"?a=!1:a.startsWith("[")&&a.endsWith("]")?a=a.slice(1,-1).split(",").map(l=>l.trim().replace(/['"]/g,"")):isNaN(Number(a))?a=a.replace(/^['"]|['"]$/g,""):a=Number(a),e[r]=a}return e}serializeFrontmatter(s){let e=[];return Object.entries(s).forEach(([t,o])=>{if(o!=null)if(Array.isArray(o)){if(o.length===0)return;e.push(`${t}: [${o.map(n=>`"${n}"`).join(", ")}]`)}else if(typeof o=="string"){let n=o.replace(/"/g,'\\"');e.push(`${t}: "${n}"`)}else typeof o=="boolean"?e.push(`${t}: ${o}`):typeof o=="number"?e.push(`${t}: ${o}`):e.push(`${t}: "${String(o)}"`)}),e.join(`
`)}async computeChecksum(s){try{let e=await this.app.vault.read(s),t=this.extractBodyContent(e);return this.hashContent(t)}catch(e){throw i.error(`Failed to compute checksum for ${s.path}`,e),e}}computeChecksumFromContent(s){let e=this.extractBodyContent(s);return this.hashContent(e)}extractBodyContent(s){let e=/^---\n[\s\S]*?\n---\n/;return s.replace(e,"").trim()}hashContent(s){let e=5381;for(let t=0;t<s.length;t++)e=(e<<5)+e+s.charCodeAt(t),e=e&e;return Math.abs(e).toString(16).padStart(8,"0")}async hasSyncMetadata(s){let e=await this.getMetadata(s);return!!(e.on_source_id||e.on_note_id)}validateMetadata(s){if(!s.on_source_id&&!s.on_note_id)return!1;if(s.on_synced_at){let e=new Date(s.on_synced_at);if(isNaN(e.getTime()))return!1}return!0}async clearMetadata(s){await this.updateMetadata(s,{on_notebook_id:void 0,on_note_id:void 0,on_source_id:void 0,on_synced_at:void 0,on_modified_at:void 0,on_checksum:void 0,on_sync_enabled:void 0,on_topics:void 0,on_ai_generated:void 0})}async hasContentChanged(s){let e=await this.getMetadata(s);return e.on_checksum?await this.computeChecksum(s)!==e.on_checksum:!0}async getBodyContent(s){let e=await this.app.vault.read(s);return this.extractBodyContent(e)}};var ne=class{constructor(s){this.isInitializing=!0;this.plugin=s,this.client=s.getAPIClient(),this.syncMappings=new Map,this.metadataManager=new oe(s.app),this.loadMappings()}loadMappings(){let s=this.plugin.settings.sourceMappings||{};Object.entries(s).forEach(([e,t])=>{this.syncMappings.set(e,t)})}async saveMappings(){let s={};this.syncMappings.forEach((e,t)=>{s[t]=e}),this.plugin.settings.sourceMappings=s,await this.plugin.saveSettings()}async syncFile(s,e){var t,o;try{i.info(`Syncing file: ${s.path} to notebook: ${e}`);let n=await this.plugin.app.vault.read(s),r=await this.metadataManager.getBodyContent(s);if(!r||r.trim().length===0)return i.debug(`File ${s.path} is empty, skipping sync`),null;let a=await this.metadataManager.computeChecksum(s),l=await this.metadataManager.getMetadata(s),d=this.syncMappings.get(s.path),u=l.on_source_id||(d==null?void 0:d.sourceId);if(u){if(l.on_sync_enabled===!1)return i.debug(`Sync disabled for ${s.path}, skipping`),u;if((l.on_checksum||(d==null?void 0:d.hash))===a)return i.debug(`File ${s.path} hasn't changed, skipping sync`),u;i.info(`Content changed for ${s.path}, recreating source (API limitation)`);try{await this.client.deleteSource(u),i.info(`Deleted old source ${u}`)}catch(m){i.error(`Failed to delete old source ${u}`,m);try{throw await this.client.getSource(u),i.error(`Source ${u} exists but couldn't be deleted - aborting to avoid duplicates`),new Error(`Cannot delete existing source ${u}`)}catch(g){i.info(`Old source ${u} doesn't exist, safe to create new one`)}}let h=await this.client.createSource({type:"text",title:s.basename,content:r,notebooks:[e],embed:!0});return await this.metadataManager.updateMetadata(s,{on_notebook_id:e,on_source_id:h.id,on_synced_at:new Date().toISOString(),on_modified_at:new Date(s.stat.mtime).toISOString(),on_checksum:a,on_sync_enabled:!0}),d?(d.sourceId=h.id,d.lastSynced=Date.now(),d.hash=a):this.syncMappings.set(s.path,{filePath:s.path,sourceId:h.id,lastSynced:Date.now(),hash:a}),await this.saveMappings(),(t=this.plugin.getSyncIndicatorManager())==null||t.refreshAll(),i.info(`Recreated source ${h.id} for file ${s.path}`),h.id}else{i.info(`Creating new source for file ${s.path}`);let p=await this.client.createSource({type:"text",title:s.basename,content:r,notebooks:[e],embed:!0});return await this.metadataManager.updateMetadata(s,{on_notebook_id:e,on_source_id:p.id,on_synced_at:new Date().toISOString(),on_modified_at:new Date(s.stat.mtime).toISOString(),on_checksum:a,on_sync_enabled:!0}),this.syncMappings.set(s.path,{filePath:s.path,sourceId:p.id,lastSynced:Date.now(),hash:a}),await this.saveMappings(),(o=this.plugin.getSyncIndicatorManager())==null||o.refreshAll(),i.info(`Created source ${p.id} for file ${s.path}`),p.id}}catch(n){throw i.error(`Failed to sync file ${s.path}`,n),n}}async syncFolder(s,e){i.info(`Syncing folder: ${s.path} to notebook: ${e}`);let t={synced:0,failed:0,skipped:0},o=this.getMarkdownFilesInFolder(s);i.info(`Found ${o.length} markdown files to sync`);for(let n of o)try{await this.syncFile(n,e),t.synced++}catch(r){i.error(`Failed to sync file ${n.path}`,r),t.failed++}return i.info(`Folder sync complete: ${t.synced} synced, ${t.failed} failed, ${t.skipped} skipped`),t}isFileInExcludedFolder(s){let e=this.plugin.settings.excludedFolders||[],t=s.path;return e.some(o=>t===o||t.startsWith(o+"/"))}getMarkdownFilesInFolder(s){let e=[],t=this.plugin.settings.excludedFolders||[],o=n=>{let r=n.name,a=n.path;if(t.some(d=>a===d||a.startsWith(d+"/")||r===d)){i.debug(`Skipping excluded folder: ${a}`);return}for(let d of n.children)d instanceof H.TFile&&d.extension==="md"?e.push(d):d instanceof H.TFolder&&o(d)};return o(s),e}async onFileCreated(s){if(this.isInitializing){i.debug(`Skipping auto-sync for ${s.path} during initialization`);return}if(this.isFileInExcludedFolder(s)){i.debug(`Skipping file in excluded folder: ${s.path}`);return}let e=s.parent;if(!e)return;let t=this.plugin.getNotebookManager().getNotebookForFolder(e.path);if(!t){i.debug(`No notebook mapped for folder ${e.path}, skipping auto-sync`);return}if(this.plugin.settings.autoSyncOnSave)try{await this.sleep(500),await this.syncFile(s,t),i.info(`Auto-synced new file ${s.path}`),c.success(`Synced new file: ${s.basename}`)}catch(o){i.error(`Failed to auto-sync new file ${s.path}`,o)}}async onFileModified(s){if(this.isFileInExcludedFolder(s)){i.debug(`Skipping file in excluded folder: ${s.path}`);return}let e=s.parent;if(!e){i.debug(`File ${s.path} has no parent folder`);return}let t=this.plugin.getNotebookManager().getNotebookForFolder(e.path);if(!t){i.debug(`No notebook mapped for folder ${e.path}`);return}if(!this.plugin.settings.autoSyncOnSave)return;let n=!!(await this.metadataManager.getMetadata(s)).on_source_id;if(!await this.metadataManager.hasContentChanged(s)&&n){i.debug(`Content hasn't changed for ${s.path}, skipping auto-sync`);return}try{await this.syncFile(s,t),n?(i.info(`Auto-synced modified file ${s.path}`),c.success(`Updated: ${s.basename}`)):(i.info(`Auto-synced new file ${s.path} (first edit)`),c.success(`Synced: ${s.basename}`))}catch(a){i.error(`Failed to auto-sync file ${s.path}`,a),c.error(`Failed to sync: ${s.basename}`)}}async onFileDeleted(s){var n;let e=await this.metadataManager.getMetadata(s),t=this.syncMappings.get(s.path),o=e.on_source_id||(t==null?void 0:t.sourceId);if(o)try{await this.client.deleteSource(o);try{await this.metadataManager.clearMetadata(s)}catch(r){i.debug(`Could not clear metadata for ${s.path} (file may be deleted)`)}this.syncMappings.delete(s.path),await this.saveMappings(),(n=this.plugin.getSyncIndicatorManager())==null||n.refreshAll(),i.info(`Deleted source ${o} for file ${s.path}`)}catch(r){i.error(`Failed to delete source for file ${s.path}`,r)}}async onFileRenamed(s,e){var r;let t=await this.metadataManager.getMetadata(s),o=this.syncMappings.get(e),n=t.on_source_id||(o==null?void 0:o.sourceId);if(n){o&&(this.syncMappings.delete(e),o.filePath=s.path,this.syncMappings.set(s.path,o),await this.saveMappings());try{await this.client.updateSource(n,{title:s.basename}),await this.metadataManager.updateMetadata(s,{on_modified_at:new Date(s.stat.mtime).toISOString()}),(r=this.plugin.getSyncIndicatorManager())==null||r.refreshAll(),i.info(`Updated source ${n} title after rename`)}catch(a){i.error("Failed to update source after rename",a)}}}getSyncStatus(s){return this.syncMappings.get(s)||null}async getSyncMetadata(s){return await this.metadataManager.getMetadata(s)}async checkForConflict(s,e){try{let t=await this.metadataManager.getBodyContent(s),o=await this.metadataManager.computeChecksum(s),n=await this.metadataManager.getMetadata(s),r=await this.client.getSource(e);if(!r)return i.warn(`Remote source ${e} not found`),null;let a=r.full_text||"",l=this.metadataManager.computeChecksumFromContent(a),d=n.on_checksum;return d&&o!==d&&(d&&l!==d)&&o!==l?(i.warn(`Conflict detected for ${s.path}: both local and remote have changes`),{resourceType:"source",resourceId:e,filePath:s.path,localVersion:{content:t,modifiedAt:new Date(s.stat.mtime),checksum:o},remoteVersion:{content:a,modifiedAt:r.updated?new Date(r.updated):new Date,checksum:l}}):null}catch(t){return i.error(`Failed to check for conflict on ${s.path}`,t),null}}async resolveConflict(s,e){try{let t=this.plugin.app.vault.getAbstractFileByPath(s.filePath);if(!t||!(t instanceof H.TFile))throw new Error(`File not found: ${s.filePath}`);let o=t.parent;if(!o)throw new Error(`File has no parent folder: ${s.filePath}`);let n=this.plugin.getNotebookManager().getNotebookForFolder(o.path);if(!n)throw new Error(`No notebook mapped for folder: ${o.path}`);e?(i.info(`Resolving conflict for ${s.filePath}: keeping local version`),await this.syncFile(t,n),c.success(`Kept local version: ${t.basename}`)):(i.info(`Resolving conflict for ${s.filePath}: keeping remote version`),await this.plugin.app.vault.modify(t,s.remoteVersion.content),await this.metadataManager.updateMetadata(t,{on_checksum:s.remoteVersion.checksum,on_synced_at:new Date().toISOString(),on_modified_at:s.remoteVersion.modifiedAt.toISOString()}),c.success(`Kept remote version: ${t.basename}`))}catch(t){throw i.error("Failed to resolve conflict",t),c.error("Failed to resolve conflict"),t}}async clearAllMappings(){this.syncMappings.clear(),await this.saveMappings(),i.info("Cleared all sync mappings")}getAllSyncedFiles(){return Array.from(this.syncMappings.values())}sleep(s){return new Promise(e=>setTimeout(e,s))}setInitializationComplete(){this.isInitializing=!1,i.info("ContentSyncManager initialization complete - auto-sync enabled")}async verifySyncState(){var o;i.info("Starting sync state verification");let s={verified:0,resynced:0,removed:0,failed:0},e=Array.from(this.syncMappings.entries()),t=[];for(let[n,r]of e)try{let a=this.plugin.app.vault.getAbstractFileByPath(n);if(!a||!(a instanceof H.TFile)){i.info(`File ${n} no longer exists, removing mapping`),t.push(n),s.removed++;continue}let l=a.parent;if(!l){i.warn(`File ${n} has no parent folder, skipping`),t.push(n),s.failed++;continue}let d=this.plugin.getNotebookManager().getNotebookForFolder(l.path);if(!d){i.warn(`No notebook mapped for folder ${l.path}, removing mapping`),t.push(n),s.removed++;continue}try{await this.plugin.getAPIClient().getSource(r.sourceId),s.verified++,i.debug(`Source ${r.sourceId} verified for ${n}`)}catch(u){i.info(`Source ${r.sourceId} not found, checking for duplicates by title`);try{let p=await this.plugin.getAPIClient().getSources(d);i.debug(`Searching ${p.length} sources for title matching: "${a.basename}"`),p.forEach(m=>i.debug(`  Available source: "${m.title}" (${m.id})`));let h=p.find(m=>m.title===a.basename);h?(i.info(`Found existing source ${h.id} for ${n}, updating mapping`),r.sourceId=h.id,r.lastSynced=Date.now(),s.verified++):(i.warn(`No matching source found for "${a.basename}" among ${p.length} sources, resyncing ${n}`),await this.syncFile(a,d),s.resynced++,i.info(`Resynced ${n} to Open Notebook`))}catch(p){i.error(`Failed to handle missing source for ${n}`,p),s.failed++}}}catch(a){i.error(`Error verifying ${n}`,a),s.failed++}for(let n of t)this.syncMappings.delete(n);return(t.length>0||s.verified>0||s.resynced>0)&&await this.saveMappings(),(o=this.plugin.getSyncIndicatorManager())==null||o.refreshAll(),i.info(`Sync state verification complete: ${s.verified} verified, ${s.resynced} resynced, ${s.removed} removed, ${s.failed} failed`),s}};var Se=require("obsidian");w();var ie=class{constructor(s){this.statusBarItem=null;this.plugin=s,this.initialize()}initialize(){this.statusBarItem=this.plugin.addStatusBarItem(),this.statusBarItem.addClass("open-notebook-sync-status"),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",()=>{this.updateEditorStatus()})),this.plugin.registerEvent(this.plugin.app.workspace.on("file-open",()=>{this.updateEditorStatus()})),this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{this.updateFileExplorer()})),this.updateEditorStatus(),setTimeout(()=>{this.updateFileExplorer()},2e3),i.info("Sync indicator manager initialized")}async updateEditorStatus(){if(!this.statusBarItem)return;let s=this.plugin.app.workspace.getActiveFile();if(!s||s.extension!=="md"){this.statusBarItem.empty();return}let e=s.parent;if(!e){this.statusBarItem.empty();return}if(!this.plugin.getNotebookManager().getNotebookForFolder(e.path)){this.statusBarItem.empty();return}let o=await this.plugin.getContentSyncManager().getSyncMetadata(s),n=this.plugin.getContentSyncManager().getSyncStatus(s.path),r=!!(o.on_source_id||n);if(this.statusBarItem.empty(),r){let a=this.statusBarItem.createSpan({cls:"on-sync-status-synced"}),l=a.createSpan({cls:"on-sync-icon"});l.innerHTML="\u2713",a.createSpan({cls:"on-sync-text"}).setText("Synced");let u="Synced to Open Notebook";if(o.on_synced_at){let p=new Date(o.on_synced_at);u=`Synced to Open Notebook ${this.getTimeAgo(p)}`}else if(n){let p=new Date(n.lastSynced);u=`Synced to Open Notebook ${this.getTimeAgo(p)}`}this.statusBarItem.setAttribute("aria-label",u)}else{let a=this.statusBarItem.createSpan({cls:"on-sync-status-unsynced"}),l=a.createSpan({cls:"on-sync-icon"});l.innerHTML="\u25CB",a.createSpan({cls:"on-sync-text"}).setText("Not synced"),this.statusBarItem.setAttribute("aria-label","Not synced to Open Notebook")}}updateFileExplorer(){setTimeout(()=>{this.addFileExplorerIndicators()},500)}async addFileExplorerIndicators(){let s=document.querySelectorAll(".tree-item-self[data-path]");s.length===0&&(s=document.querySelectorAll("[data-path].tree-item-self"),console.log(`[Sync Indicators] Trying alternative selector 1: found ${s.length}`)),s.length===0&&(s=document.querySelectorAll(".nav-file[data-path]"),console.log(`[Sync Indicators] Trying alternative selector 2: found ${s.length}`)),s.length===0&&(s=document.querySelectorAll(".tree-item[data-path]"),console.log(`[Sync Indicators] Trying alternative selector 3: found ${s.length}`)),console.log(`[Sync Indicators] Final count: ${s.length} file items in explorer`);let e=document.querySelectorAll(".tree-item"),t=document.querySelectorAll(".tree-item-self");console.log(`[Sync Indicators] DOM Debug - .tree-item: ${e.length}, .tree-item-self: ${t.length}`),i.debug(`Found ${s.length} file items in explorer`);let o=this.plugin.getContentSyncManager().getAllSyncedFiles();console.log("[Sync Indicators] Synced files:",o.map(n=>n.filePath));for(let n of Array.from(s)){let r=n,a=r.getAttribute("data-path");if(!a||!a.endsWith(".md"))continue;let l=r.querySelector(".tree-item-inner");if(!l){console.log(`[Sync Indicators] No title element found for ${a}`),i.debug(`No title element found for ${a}`);continue}let d=r.querySelector(".on-sync-indicator");d&&d.remove();let u=this.plugin.app.vault.getAbstractFileByPath(a);if(!u||!(u instanceof Se.TFile))continue;let p=await this.plugin.getContentSyncManager().getSyncMetadata(u),h=this.plugin.getContentSyncManager().getSyncStatus(a);if(!!(p.on_source_id||h)){console.log(`[Sync Indicators] Adding indicator for synced file: ${a}`),i.debug(`Adding indicator for synced file: ${a}`);let g=document.createElement("span");g.addClass("on-sync-indicator"),g.addClass("on-synced"),g.innerHTML="\u2713 ",g.setAttribute("aria-label","Synced to Open Notebook"),g.style.cssText="color: #22c55e; margin-right: 4px; font-size: 1em; font-weight: bold; display: inline-block;",l.insertBefore(g,l.firstChild),console.log("[Sync Indicators] Indicator added to:",l),console.log("[Sync Indicators] Indicator element:",g),console.log("[Sync Indicators] Parent element classes:",r.className)}}}refreshAll(){this.updateEditorStatus(),this.updateFileExplorer()}getTimeAgo(s){let e=Math.floor((Date.now()-s.getTime())/1e3);if(e<60)return"just now";let t=Math.floor(e/60);if(t<60)return`${t}m ago`;let o=Math.floor(t/60);return o<24?`${o}h ago`:`${Math.floor(o/24)}d ago`}destroy(){this.statusBarItem&&this.statusBarItem.remove()}};w();E();var ae=class{constructor(s,e){this.client=s;this.saveCallback=e;this.queue=[];this.isOnline=!0;this.processing=!1;this.processInterval=null}async initialize(s){this.queue=s||[],i.info(`Offline queue initialized with ${this.queue.length} operations`),this.queue.length>0&&await this.processQueue()}async enqueue(s){let e=this.queue.find(t=>t.resourceType===s.resourceType&&t.resourceId===s.resourceId&&t.type===s.type);e?(e.data=s.data,e.timestamp=s.timestamp,i.debug(`Updated existing operation in queue: ${s.id}`)):(this.queue.push(s),i.info(`Enqueued operation: ${s.type} ${s.resourceType} ${s.resourceId||s.localPath}`)),await this.saveQueue(),this.isOnline&&!this.processing&&await this.processQueue()}async processQueue(){if(this.processing){i.debug("Queue already processing, skipping");return}if(this.queue.length===0){i.debug("Queue is empty, nothing to process");return}this.processing=!0,i.info(`Processing queue with ${this.queue.length} operations`);let s=this.queue.filter(e=>e.status==="pending"||e.status==="failed");for(let e of s)try{await this.processOperation(e)}catch(t){i.error(`Failed to process operation ${e.id}`,t),e.status="failed",e.attempts++,e.error=t instanceof Error?t.message:"Unknown error",e.attempts>=3&&(i.warn(`Operation ${e.id} failed after ${e.attempts} attempts, removing from queue`),this.queue=this.queue.filter(o=>o.id!==e.id),c.error(`Sync operation failed: ${e.type} ${e.resourceType}`))}await this.saveQueue(),this.processing=!1,i.info(`Queue processing complete. Remaining: ${this.queue.length}`)}async processOperation(s){s.status="processing",s.attempts++,i.debug(`Processing operation: ${s.type} ${s.resourceType} ${s.resourceId}`);try{switch(s.resourceType){case"source":await this.processSourceOperation(s);break;case"note":await this.processNoteOperation(s);break;case"notebook":await this.processNotebookOperation(s);break;default:throw new Error(`Unknown resource type: ${s.resourceType}`)}s.status="completed",this.queue=this.queue.filter(e=>e.id!==s.id),i.info(`Operation completed: ${s.id}`)}catch(e){throw i.error(`Operation failed: ${s.id}`,e),e}}async processSourceOperation(s){switch(s.type){case"create":await this.client.createSource(s.data);break;case"update":if(!s.resourceId)throw new Error("Resource ID required for update");await this.client.updateSource(s.resourceId,s.data);break;case"delete":if(!s.resourceId)throw new Error("Resource ID required for delete");await this.client.deleteSource(s.resourceId);break}}async processNoteOperation(s){switch(s.type){case"create":await this.client.createNote(s.data);break;case"update":if(!s.resourceId)throw new Error("Resource ID required for update");await this.client.updateNote(s.resourceId,s.data);break;case"delete":if(!s.resourceId)throw new Error("Resource ID required for delete");await this.client.deleteNote(s.resourceId);break}}async processNotebookOperation(s){switch(s.type){case"create":await this.client.createNotebook(s.data);break;case"update":if(!s.resourceId)throw new Error("Resource ID required for update");await this.client.updateNotebook(s.resourceId,s.data);break;case"delete":if(!s.resourceId)throw new Error("Resource ID required for delete");await this.client.deleteNotebook(s.resourceId);break}}async retryOperation(s){let e=this.queue.find(t=>t.id===s);if(!e)throw new Error(`Operation ${s} not found in queue`);e.status="pending",e.attempts=0,e.error=void 0,await this.saveQueue(),await this.processQueue()}async clearQueue(){this.queue=[],await this.saveQueue(),i.info("Queue cleared")}getQueueSize(){return this.queue.length}getQueuedOperations(){return[...this.queue]}isProcessing(){return this.processing}setOnlineStatus(s){let e=!this.isOnline;this.isOnline=s,s&&e&&this.queue.length>0&&(i.info("Connection restored, processing queue"),c.info(`Connection restored. Processing ${this.queue.length} queued operations...`),this.processQueue())}async saveQueue(){await this.saveCallback(this.queue)}startAutoProcess(s=3e4){this.processInterval||(this.processInterval=window.setInterval(()=>{this.queue.length>0&&!this.processing&&(i.debug("Auto-processing queue"),this.processQueue())},s),i.info(`Auto-process started with ${s}ms interval`))}stopAutoProcess(){this.processInterval&&(window.clearInterval(this.processInterval),this.processInterval=null,i.info("Auto-process stopped"))}async cleanup(){this.stopAutoProcess(),await this.saveQueue()}};var Ee=require("obsidian");var re=class{fromAPI(s){return{id:s.id,title:s.title,notebookId:s.notebook_id,sourceId:s.source_id,modelOverride:s.model_override,created:new Date(s.created),updated:new Date(s.updated),messages:[]}}messageFromAPI(s){var e;return{id:s.id,role:s.role,content:s.content,timestamp:new Date(s.timestamp),sources:(e=s.sources)==null?void 0:e.map(t=>this.sourceRefFromAPI(t))}}sourceRefFromAPI(s){return{sourceId:s.source_id,title:s.title,excerpt:s.excerpt}}toAPI(s){return{title:s.title,notebook_id:s.notebookId,source_id:s.sourceId,model_override:s.modelOverride}}};w();E();var I="open-notebook-chat",x=class extends Ee.ItemView{constructor(e,t){super(e);this.currentSession=null;this.currentNotebookId=null;this.plugin=t,this.chatAdapter=new re}getViewType(){return I}getDisplayText(){return"Open Notebook Chat"}getIcon(){return"message-circle"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("open-notebook-chat-view"),this.headerEl=e.createDiv({cls:"chat-header"}),this.renderHeader(),this.contextEl=e.createDiv({cls:"chat-context"}),this.contextEl.setText("No notebook selected"),this.messagesEl=e.createDiv({cls:"chat-messages"});let t=e.createDiv({cls:"chat-input-container"});this.inputEl=t.createEl("textarea",{cls:"chat-input",attr:{placeholder:"Type your message...",rows:"3"}}),this.sendButtonEl=t.createEl("button",{cls:"chat-send-button",text:"Send"}),this.sendButtonEl.addEventListener("click",()=>this.handleSend()),this.inputEl.addEventListener("keydown",o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),this.handleSend())}),i.info("Chat view opened")}async onClose(){i.info("Chat view closed")}async setNotebook(e){this.currentNotebookId=e;try{let t=await this.plugin.getNotebookManager().getNotebook(e);t?(this.contextEl.setText(`\u{1F4DA} ${t.name}`),await this.loadOrCreateSession(e),this.inputEl.disabled=!1,this.sendButtonEl.disabled=!1):this.contextEl.setText("\u26A0 Notebook not found")}catch(t){i.error("Failed to set notebook context",t),c.error("Failed to load notebook")}}showNotLinked(){this.currentNotebookId=null,this.currentSession=null,this.contextEl.setText("\u26A0 Not linked to Open Notebook"),this.messagesEl.empty();let e=this.messagesEl.createDiv({cls:"chat-not-linked-message"});e.createEl("p",{text:"\u{1F4C1} This folder is not linked to an Open Notebook."}),e.createEl("p",{text:"Right-click the folder in the file explorer to create or link a notebook."}),this.inputEl.disabled=!0,this.sendButtonEl.disabled=!0,this.inputEl.placeholder="Link a folder to enable chat...",this.headerEl.empty(),this.headerEl.createDiv({cls:"chat-title"}).setText("Open Notebook Chat")}async loadOrCreateSession(e){this.messagesEl.empty();let t=this.createLoadingElement();this.messagesEl.appendChild(t);let o=t.querySelector(".chat-message-content");o&&o.querySelector(".chat-loading-spinner")&&(o.empty(),o.createSpan({cls:"chat-loading-spinner",text:"\u25CF\u25CF\u25CF"}),o.createSpan({text:" Loading chat session..."}));try{let n=this.plugin.getAPIClient(),r=[];try{r=await n.getChatSessions(e)}catch(a){if(a.statusCode===404)r=[];else throw a}if(r.length>0){let a=r[0];this.currentSession=this.chatAdapter.fromAPI(a),o&&(o.empty(),o.createSpan({cls:"chat-loading-spinner",text:"\u25CF\u25CF\u25CF"}),o.createSpan({text:" Loading messages..."}));try{let l=await n.getChatSession(this.currentSession.id);if(l.messages&&Array.isArray(l.messages))this.currentSession.messages=l.messages.map(d=>{let u={id:d.id,role:d.role||(d.type==="human"?"user":d.type==="ai"?"assistant":"system"),content:d.content,timestamp:d.timestamp,sources:d.sources||[]};return this.chatAdapter.messageFromAPI(u)}),this.renderMessages();else try{let d=await n.getChatMessages(this.currentSession.id);this.currentSession.messages=d.map(u=>{let p={id:u.id,role:u.role||(u.type==="human"?"user":u.type==="ai"?"assistant":"system"),content:u.content,timestamp:u.timestamp,sources:u.sources||[]};return this.chatAdapter.messageFromAPI(p)}),this.renderMessages()}catch(d){if(d.statusCode===404)this.currentSession.messages=[],this.renderMessages();else throw d}}catch(l){i.error("Failed to get session details",l),this.currentSession.messages=[],this.renderMessages()}}else try{o&&(o.empty(),o.createSpan({cls:"chat-loading-spinner",text:"\u25CF\u25CF\u25CF"}),o.createSpan({text:" Creating new chat session..."}));let a=this.plugin.settings.defaultChatModel,l=await n.createChatSession({notebook_id:e,title:"New Chat",model_override:a});this.currentSession=this.chatAdapter.fromAPI(l),this.messagesEl.empty()}catch(a){throw i.error("Failed to create session",a),a}t.remove(),this.renderHeader()}catch(n){i.error("Failed to load/create session",n);let r=n.message||"Unknown error";c.error(`Failed to load chat session: ${r}`),t.remove(),this.messagesEl.empty();let a=this.messagesEl.createDiv({cls:"chat-error-message"});a.createEl("p",{text:"\u26A0\uFE0F Failed to load chat session"}),a.createEl("p",{text:r,cls:"chat-error-details"})}}async handleSend(){let e=this.inputEl.value.trim();if(!e)return;if(!this.currentSession){c.warn("Please select a notebook first");return}this.inputEl.disabled=!0,this.sendButtonEl.disabled=!0,this.inputEl.value="",this.addUserMessage(e);let t=this.createLoadingElement();this.messagesEl.appendChild(t),this.scrollToBottom();try{let o=this.plugin.getAPIClient(),n={};this.currentNotebookId&&(n.notebook_id=this.currentNotebookId);let r=await o.sendMessage(this.currentSession.id,e,n);if(t.remove(),r.messages&&Array.isArray(r.messages)){this.currentSession.messages=r.messages.map(l=>{let d={id:l.id,role:l.type==="human"?"user":l.type==="ai"?"assistant":"system",content:l.content,timestamp:l.timestamp,sources:l.sources||[]};return this.chatAdapter.messageFromAPI(d)});let a=[...this.currentSession.messages].reverse().find(l=>l.role==="assistant");if(a){let l=this.createMessageElement("assistant","");this.messagesEl.appendChild(l),await this.animateMessageContent(l,a.content)}}}catch(o){i.error("Failed to send message",o),c.error("Failed to send message"),t.remove()}finally{this.inputEl.disabled=!1,this.sendButtonEl.disabled=!1,this.inputEl.focus()}}addUserMessage(e){let t=this.createMessageElement("user",e);this.messagesEl.appendChild(t),this.scrollToBottom()}createMessageElement(e,t){let o=this.messagesEl.createDiv({cls:`chat-message chat-message-${e}`});return o.createDiv({cls:"chat-message-role"}).setText(e==="user"?"You":"AI"),o.createDiv({cls:"chat-message-content"}).setText(t),o}updateMessageContent(e,t){let o=e.querySelector(".chat-message-content");o&&o.setText(t)}renderMessages(){if(this.messagesEl.empty(),!(!this.currentSession||!this.currentSession.messages)){for(let e of this.currentSession.messages){let t=this.createMessageElement(e.role,e.content);this.messagesEl.appendChild(t)}this.scrollToBottom()}}renderHeader(){var o;this.headerEl.empty(),this.headerEl.createDiv({cls:"chat-title"}).setText(((o=this.currentSession)==null?void 0:o.title)||"Open Notebook Chat"),this.headerEl.createEl("button",{cls:"chat-new-session-button",text:"+ New"}).addEventListener("click",async()=>{this.currentNotebookId&&await this.createNewSession(this.currentNotebookId)})}async createNewSession(e){try{let t=this.plugin.getAPIClient(),o=this.plugin.settings.defaultChatModel,n=await t.createChatSession({notebook_id:e,title:"New Chat",model_override:o});this.currentSession=this.chatAdapter.fromAPI(n),this.messagesEl.empty(),this.renderHeader(),c.success("New chat session created")}catch(t){i.error("Failed to create new session",t),c.error("Failed to create new session")}}scrollToBottom(){this.messagesEl.scrollTop=this.messagesEl.scrollHeight}createLoadingElement(){let e=this.messagesEl.createDiv({cls:"chat-message chat-message-assistant chat-loading"});return e.createDiv({cls:"chat-message-role"}).setText("AI"),e.createDiv({cls:"chat-message-content"}).createSpan({cls:"chat-loading-spinner"}).setText("\u25CF\u25CF\u25CF"),e}async animateMessageContent(e,t){let o=e.querySelector(".chat-message-content");if(!o)return;let n=2,r=10,a=0;for(;a<t.length;){let l=Math.min(a+n,t.length),d=t.substring(0,l);o.setText(d),this.scrollToBottom(),a=l,a<t.length&&await this.sleep(r)}}sleep(e){return new Promise(t=>setTimeout(t,e))}};var le=require("obsidian");w();E();var ce=class extends le.Modal{constructor(e,t){super(e);this.searchType="vector";this.searchSources=!0;this.searchNotes=!0;this.results=[];this.selectedIndex=0;this.plugin=t,this.searchType=t.settings.defaultSearchMode}onOpen(){let{contentEl:e,modalEl:t}=this;e.empty(),e.addClass("open-notebook-search-modal"),t&&(t.style.width="90vw",t.style.maxWidth="1200px"),e.createEl("h2",{text:"Search Open Notebook"});let o=e.createDiv({cls:"search-input-section"}),n=o.createDiv({cls:"search-input-container"});this.queryInput=n.createEl("input",{type:"text",placeholder:"Enter search query...",cls:"search-input"});let r=n.createEl("button",{text:"\u{1F50D}",cls:"search-button"});this.queryInput.addEventListener("keydown",T=>{T.key==="Enter"?(T.preventDefault(),this.performSearch()):T.key==="ArrowDown"?(T.preventDefault(),this.selectNext()):T.key==="ArrowUp"&&(T.preventDefault(),this.selectPrevious())}),r.addEventListener("click",()=>this.performSearch());let a=o.createDiv({cls:"search-options"}),l=a.createDiv({cls:"search-type-container"}),d=l.createEl("label"),u=d.createEl("input",{type:"radio",attr:{name:"search-type",value:"text"}});u.checked=this.searchType==="text",d.appendText(" Text");let p=l.createEl("label"),h=p.createEl("input",{type:"radio",attr:{name:"search-type",value:"vector"}});h.checked=this.searchType==="vector",p.appendText(" Vector (Semantic)"),u.addEventListener("change",()=>{this.searchType="text"}),h.addEventListener("change",()=>{this.searchType="vector"});let m=a.createDiv({cls:"search-scope-container"}),g=m.createEl("label"),y=g.createEl("input",{type:"checkbox",attr:{name:"search-sources"}});y.checked=this.searchSources,g.appendText(" Sources");let k=m.createEl("label"),P=k.createEl("input",{type:"checkbox",attr:{name:"search-notes"}});P.checked=this.searchNotes,k.appendText(" Notes"),y.addEventListener("change",()=>{this.searchSources=y.checked}),P.addEventListener("change",()=>{this.searchNotes=P.checked});let v=e.createDiv({cls:"search-results-section"}),N=v.createDiv({cls:"search-results-list-container"});N.createEl("h3",{text:"Results"}),this.resultsContainer=N.createDiv({cls:"search-results-list"}),this.renderEmptyState();let z=v.createDiv({cls:"search-preview-pane"});z.createEl("h3",{text:"Preview"}),this.previewContainer=z.createDiv({cls:"search-preview-content"}),this.queryInput.focus()}onClose(){let{contentEl:e}=this;e.empty()}async performSearch(){var o;let e=this.queryInput.value.trim();if(!e){c.warn("Please enter a search query");return}this.resultsContainer.empty();let t=this.resultsContainer.createDiv({cls:"search-loading"});t.createEl("div",{cls:"search-loading-spinner",text:"\u25CF\u25CF\u25CF"}),t.createEl("div",{text:"Searching..."});try{let n=this.plugin.getAPIClient(),r,a=this.app.workspace.getActiveFile();if(a){let u=((o=a.parent)==null?void 0:o.path)||"";r=this.plugin.getFolderMapping(u),r&&i.info("Searching in notebook:",r,"for folder:",u)}let l=await n.search({query:e,type:this.searchType,limit:50,searchSources:this.searchSources,searchNotes:this.searchNotes,notebookId:r}),d=l.filter(u=>{let p=u.id.startsWith("note:"),h=u.id.startsWith("podcast:"),m=u.id.startsWith("source_insight:"),g=u.id.startsWith("source:");return m?(i.debug(`Filtering out insight: ${u.id} (${u.title})`),!1):g||p||h?(i.debug(`Keeping: ${u.id} (${u.title})`),!0):(i.debug(`Filtering out unknown type: ${u.id} (${u.title})`),!1)});i.info(`Filtered ${l.length} results to ${d.length} (sources only, no insights)`),d.sort((u,p)=>p.score-u.score),this.results=d,this.selectedIndex=0,i.info(`Search returned ${d.length} results`),this.renderResults(),d.length>0&&this.renderPreview(d[0])}catch(n){i.error("Search failed",n),c.error("Search failed"),this.resultsContainer.empty(),this.resultsContainer.createDiv({cls:"search-error",text:`Search failed: ${n instanceof Error?n.message:"Unknown error"}`})}}renderEmptyState(){this.resultsContainer.empty(),this.resultsContainer.createDiv({cls:"search-empty-state",text:"Enter a query and press Enter to search"})}renderResults(){if(this.resultsContainer.empty(),this.results.length===0){this.resultsContainer.createDiv({cls:"search-no-results",text:"No results found"});return}this.resultsContainer.createDiv({cls:"search-results-count",text:`${this.results.length} result${this.results.length===1?"":"s"}`}),this.results.forEach((e,t)=>{let o=this.resultsContainer.createDiv({cls:`search-result-item ${t===this.selectedIndex?"selected":""}`});o.createSpan({cls:"search-result-icon"}).setText(e.type==="source"?"\u{1F4C4}":"\u{1F4DD}");let r=o.createDiv({cls:"search-result-content"});r.createDiv({cls:"search-result-title"}).setText(e.title||"Untitled"),r.createDiv({cls:"search-result-excerpt"}).setText(this.truncateExcerpt(e.excerpt)),e.score>0&&o.createDiv({cls:"search-result-score"}).setText(`${Math.round(e.score*100)}%`),o.addEventListener("click",()=>{this.selectedIndex=t,this.renderResults(),this.renderPreview(e)})})}async renderPreview(e){if(this.previewContainer.empty(),i.debug("Rendering preview for result:",e),this.previewContainer.createEl("h4",{text:e.title||"Untitled"}),this.previewContainer.createDiv({cls:"search-preview-metadata"}).createDiv({text:`Type: ${e.type} | ID: ${e.id}`,cls:"search-result-info"}),e.metadata){let p=this.previewContainer.createDiv({cls:"search-preview-metadata"});if(e.metadata.topics&&e.metadata.topics.length>0){let h=p.createDiv({cls:"search-preview-topics"});h.createSpan({text:"Topics: "}),e.metadata.topics.forEach(m=>{h.createSpan({cls:"topic-tag",text:m})})}e.metadata.created&&p.createDiv({text:`Created: ${new Date(e.metadata.created).toLocaleDateString()}`})}let o=this.previewContainer.createDiv({cls:"search-preview-text"}),n=e.content||e.excerpt||"";if(!n){o.createDiv({cls:"search-loading",text:"Loading content..."});try{let p=this.plugin.getAPIClient();e.id.startsWith("source:")||e.id.startsWith("source_insight:")?(n=(await p.getSource(e.id)).full_text||"",i.debug("Fetched source content:",n.length,"chars")):(n=(await p.getNote(e.id)).content||"",i.debug("Fetched note content:",n.length,"chars")),e.content=n,o.empty()}catch(p){i.error("Failed to fetch content:",p),o.empty(),o.createDiv({text:"Failed to load content",cls:"search-no-content"});return}}if(n){let p=o.createDiv({cls:"search-preview-markdown"});le.MarkdownRenderer.render(this.app,n,p,"",this.plugin)}else o.createDiv({text:"No content available for preview",cls:"search-no-content"}),i.warn("No content available for result:",e);let r=this.previewContainer.createDiv({cls:"search-preview-actions"});r.createEl("button",{text:"Insert Link",cls:"mod-cta"}).addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),i.info("Insert Link clicked for:",e),this.insertAsLink(e)}),r.createEl("button",{text:"Insert Quote"}).addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),i.info("Insert Quote clicked for:",e),this.insertAsQuote(e)}),r.createEl("button",{text:"Create Note"}).addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),i.info("Create Note clicked for:",e),this.createNote(e)}),r.createEl("button",{text:"View in Open Notebook"}).addEventListener("click",p=>{p.preventDefault(),p.stopPropagation(),this.openInOpenNotebook(e)})}selectNext(){this.results.length!==0&&(this.selectedIndex=(this.selectedIndex+1)%this.results.length,this.renderResults(),this.renderPreview(this.results[this.selectedIndex]))}selectPrevious(){this.results.length!==0&&(this.selectedIndex=(this.selectedIndex-1+this.results.length)%this.results.length,this.renderResults(),this.renderPreview(this.results[this.selectedIndex]))}insertAsLink(e){var n;let t=(n=this.app.workspace.activeEditor)==null?void 0:n.editor;if(!t){c.warn("No active editor");return}let o=`[${e.title}](open-notebook://${e.type}/${e.id})`;t.replaceSelection(o),c.success("Link inserted"),this.close()}insertAsQuote(e){var l;let t=(l=this.app.workspace.activeEditor)==null?void 0:l.editor;if(!t){c.warn("No active editor");return}let o=window.getSelection(),n="";if(o&&o.toString().trim().length>0?(n=o.toString().trim(),i.info("Using selected text for quote:",n.length,"chars")):(n=e.excerpt||e.content||"",i.info("Using full excerpt/content for quote")),!n){c.warn("No content to quote");return}let r;e.id.startsWith("source:")?r=`Source: ${`[${e.title}](open-notebook://${e.type}/${e.id})`}`:r=`Source: ${e.title}`;let a=`> ${n.split(`
`).join(`
> `)}

${r}`;t.replaceSelection(a),c.success("Quote inserted"),this.close()}async createNote(e){try{let t=window.getSelection(),o="";if(t&&t.toString().trim().length>0?(o=t.toString().trim(),i.info("Using selected text for note:",o.length,"chars")):(o=e.content||e.excerpt||"",i.info("Using full content/excerpt for note")),!o){c.warn("No content available to create note");return}let r=`${(e.title||"Search Result").replace(/[\\/:*?"<>|]/g,"-")}.md`;i.info("Creating note:",r);let a=await this.app.vault.create(r,o);c.success(`Note created: ${r}`),this.close(),await this.app.workspace.getLeaf(!1).openFile(a)}catch(t){i.error("Failed to create note",t),c.error(`Failed to create note: ${t.message}`)}}openInOpenNotebook(e){let o=`${this.plugin.settings.apiEndpoint}/${e.type}s/${e.id}`;i.info("Opening in Open Notebook:",o),window.open(o,"_blank"),c.info("Opening in browser...")}truncateExcerpt(e,t=150){return e.length<=t?e:e.substring(0,t)+"..."}truncateContent(e,t=30){let o=e.split(`
`);return o.length<=t?e:o.slice(0,t).join(`
`)+`

... (truncated)`}};var V=require("obsidian");w();E();var Q=class extends V.Modal{constructor(e,t,o,n){super(e);this.insights=[];this.selectedInsight=null;this.isLoading=!1;this.plugin=t,this.sourceId=o,this.sourceTitle=n}async onOpen(){let{contentEl:e,modalEl:t}=this;e.empty(),e.addClass("open-notebook-insights-modal"),t&&(t.style.width="90vw",t.style.maxWidth="1200px"),e.createDiv({cls:"insights-header-container"}).createEl("h2",{text:`Insights: ${this.sourceTitle}`});let n=e.createDiv({cls:"insights-results-section"}),r=n.createDiv({cls:"insights-list-container"}),a=r.createDiv({cls:"insights-list-header"});a.createEl("h3",{text:"Insights"}),a.createEl("button",{text:"\u2728 Generate Insight",cls:"mod-cta insights-generate-button"}).addEventListener("click",async()=>{await this.generateInsightFromCurrentNote()}),this.listEl=r.createDiv({cls:"insights-list"});let d=n.createDiv({cls:"insights-preview-pane"});d.createEl("h3",{text:"Preview"}),this.previewEl=d.createDiv({cls:"insights-preview-content"}),await this.loadInsights()}onClose(){let{contentEl:e}=this;e.empty()}async loadInsights(){if(!this.isLoading){this.isLoading=!0,this.listEl.empty(),this.previewEl.empty(),this.listEl.createDiv({cls:"insights-loading",text:"Loading insights..."});try{let e=this.plugin.getAPIClient();this.insights=await e.getInsights(this.sourceId),i.info(`Loaded ${this.insights.length} insights for source ${this.sourceId}`),this.renderInsightsList(),this.insights.length>0?this.selectInsight(this.insights[0]):this.showEmptyState()}catch(e){i.error("Failed to load insights",e),e.statusCode===404?this.showEmptyState(!0):(this.listEl.empty(),this.listEl.createDiv({cls:"insights-error",text:`Failed to load insights: ${e.message||"Unknown error"}`}))}finally{this.isLoading=!1}}}showEmptyState(e=!1){this.listEl.empty(),this.previewEl.empty(),this.listEl.createDiv({cls:"insights-empty-state",text:'No insights available. Click "Generate Insight" to create insights from your notes.'}),this.previewEl.createDiv({cls:"insights-empty-state",text:"Select an insight to preview"})}renderInsightsList(){var t,o;if(this.listEl.empty(),this.insights.length===0){this.listEl.createDiv({cls:"insights-no-results",text:"No insights available"});return}this.listEl.createDiv({cls:"insights-count"}).setText(`${this.insights.length} insight${this.insights.length===1?"":"s"} found`);for(let n of this.insights){let r=this.listEl.createDiv({cls:"insight-item"});r.createDiv({cls:"insight-icon"}).setText("\u2728");let l=r.createDiv({cls:"insight-content"}),d=n.title;if(!d||d==="Untitled Insight"||d.trim()===""){let y=n.insight_type||"Insight",k=((o=(t=n.content)==null?void 0:t.split(`
`)[0])==null?void 0:o.trim().substring(0,50))||"";k?d=`${y}: ${k}`:d=`${y}`}l.createDiv({cls:"insight-title"}).setText(d);let p;n.created?(p=new Date(n.created),isNaN(p.getTime())&&(p=new Date)):p=new Date;let h=l.createDiv({cls:"insight-metadata"}),m=n.insight_type||"insight",g=p.toLocaleDateString();h.setText(`${m} \u2022 ${g}`),r.addEventListener("click",()=>{this.selectInsight(n)}),r.addEventListener("contextmenu",y=>{y.preventDefault();let k=new V.Menu;k.addItem(P=>{P.setTitle("Delete Insight").setIcon("trash").onClick(async()=>{await this.deleteInsight(n)})}),k.showAtMouseEvent(y)})}}selectInsight(e){this.selectedInsight=e,this.listEl.querySelectorAll(".insight-item").forEach((o,n)=>{this.insights[n]===e?o.addClass("selected"):o.removeClass("selected")}),this.renderPreview(e)}async renderPreview(e){var g,y,k,P;this.previewEl.empty();let t=e.title;if(!t||t==="Untitled Insight"||t.trim()===""){let v=e.insight_type||"Insight",N=((y=(g=e.content)==null?void 0:g.split(`
`)[0])==null?void 0:y.trim().substring(0,50))||"";N?t=`${v}: ${N}`:t=`${v} - ${new Date().toLocaleDateString()}`}this.previewEl.createEl("h4",{text:t});let o=this.previewEl.createDiv({cls:"insights-preview-metadata"}),n=o.createDiv();n.createEl("strong",{text:"Type: "}),n.createSpan({text:e.insight_type||"insight"});let r;e.created?(r=new Date(e.created),isNaN(r.getTime())&&(r=new Date)):r=new Date;let a=o.createDiv();if(a.createEl("strong",{text:"Created: "}),a.createSpan({text:`${r.toLocaleDateString()} ${r.toLocaleTimeString()}`}),(k=e.metadata)!=null&&k.topics&&e.metadata.topics.length>0){let v=o.createDiv({cls:"insights-preview-topics"});v.createEl("strong",{text:"Topics: "});let N=v.createSpan();for(let z of e.metadata.topics)N.createSpan({cls:"topic-tag",text:z})}if(((P=e.metadata)==null?void 0:P.confidence)!==void 0){let v=o.createDiv();v.createEl("strong",{text:"Confidence: "}),v.createSpan({text:`${Math.round(e.metadata.confidence*100)}%`})}let l=this.previewEl.createDiv({cls:"insights-preview-text"});if(e.content){let v=l.createDiv({cls:"insights-preview-markdown"});await V.MarkdownRenderer.render(this.app,e.content,v,"",this.plugin)}else l.createDiv({cls:"insights-no-content",text:"No content available for this insight"});let d=this.previewEl.createDiv({cls:"insights-preview-actions"});d.createEl("button",{text:"Save as Note",cls:"mod-cta"}).addEventListener("click",async v=>{v.preventDefault(),v.stopPropagation(),await this.saveInsightAsNote(e)}),d.createEl("button",{text:"Insert Quote"}).addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),this.insertAsQuote(e)}),d.createEl("button",{text:"Copy to Clipboard"}).addEventListener("click",v=>{v.preventDefault(),v.stopPropagation(),this.copyInsightToClipboard(e)}),d.createEl("button",{text:"Delete",cls:"mod-warning"}).addEventListener("click",async v=>{v.preventDefault(),v.stopPropagation(),await this.deleteInsight(e)})}async saveInsightAsNote(e){var t,o;try{let n=e.title;if(!n||n==="Untitled Insight"||n.trim()===""){let g=e.insight_type||"Insight",y=((o=(t=e.content)==null?void 0:t.split(`
`)[0])==null?void 0:o.trim().substring(0,50))||"";y?n=`${g}: ${y}`:n=`${g} - ${new Date().toLocaleDateString()}`}let a=`${n.replace(/[\\/:*?"<>|]/g,"-").substring(0,100)}.md`,l=this.app.workspace.getActiveFile(),d=(l==null?void 0:l.parent)||this.app.vault.getRoot(),u=this.formatInsightAsNote(e);if(this.app.vault.getAbstractFileByPath(d.path==="/"?a:`${d.path}/${a}`)){c.warn("A file with this name already exists");return}let h=await this.app.vault.create(d.path==="/"?a:`${d.path}/${a}`,u);c.success(`Saved insight as: ${a}`),await this.app.workspace.getLeaf(!1).openFile(h),this.close()}catch(n){i.error("Failed to save insight as note",n),c.error(`Failed to save insight: ${n.message||"Unknown error"}`)}}formatInsightAsNote(e){var r,a,l,d;let t=e.title;if(!t||t==="Untitled Insight"||t.trim()===""){let u=e.insight_type||"Insight",p=((a=(r=e.content)==null?void 0:r.split(`
`)[0])==null?void 0:a.trim().substring(0,50))||"";p?t=`${u}: ${p}`:t=`${u} - ${new Date().toLocaleDateString()}`}let o=`# ${t}

`;o+=`> **Type:** ${e.insight_type||"insight"}  
`;let n;return e.created?(n=new Date(e.created),isNaN(n.getTime())&&(n=new Date)):n=new Date,o+=`> **Created:** ${n.toLocaleDateString()} ${n.toLocaleTimeString()}  
`,(l=e.metadata)!=null&&l.topics&&e.metadata.topics.length>0&&(o+=`> **Topics:** ${e.metadata.topics.join(", ")}  
`),((d=e.metadata)==null?void 0:d.confidence)!==void 0&&(o+=`> **Confidence:** ${Math.round(e.metadata.confidence*100)}%  
`),o+=`> **Source:** \`${e.source_id}\`  
`,o+=`
`,e.content&&(o+=`${e.content}
`),o+=`
---

`,o+=`*AI-generated insight from Open Notebook*
`,o}copyInsightToClipboard(e){let t=this.formatInsightAsNote(e);navigator.clipboard.writeText(t).then(()=>{c.success("Copied insight to clipboard")}).catch(o=>{i.error("Failed to copy to clipboard",o),c.error("Failed to copy to clipboard")})}insertAsQuote(e){var t;try{let o=(t=this.app.workspace.activeEditor)==null?void 0:t.editor;if(!o){c.warn("No active editor to insert quote");return}let n=window.getSelection(),r="";if(n&&n.toString().trim().length>0?(r=n.toString().trim(),i.info("Using selected text for quote:",r.length,"chars")):(r=e.content||"",i.info("Using full insight content for quote")),!r){c.warn("No content to quote");return}let a=r.split(`
`).map(u=>`> ${u}`).join(`
`),l=`*AI Insight: ${e.title||"Untitled"}* (${e.insight_type||"insight"})`,d=`${a}

${l}`;o.replaceSelection(d),c.success("Quote inserted"),i.info("Inserted quote from insight:",e.id),this.close()}catch(o){i.error("Failed to insert quote",o),c.error("Failed to insert quote")}}async generateInsightFromCurrentNote(){let e=c.loading("Generating insight...");try{let t=this.plugin.getAPIClient(),o=await t.getTransformations();if(!o||o.length===0){c.hideNotice(e),c.warn("No transformations available. Please create a transformation first.");return}let n=o[0].id;i.info(`Using transformation: ${n}`);let r=await t.generateInsight(this.sourceId,n);c.hideNotice(e),c.success("Insight generated successfully!"),i.info("Generated insight:",r.id),await this.loadInsights()}catch(t){c.hideNotice(e),i.error("Failed to generate insight",t),c.error(`Failed to generate insight: ${t.message||"Unknown error"}`)}}async deleteInsight(e){var t,o;try{let n=e.title;if(!n||n==="Untitled Insight"||n.trim()===""){let l=e.insight_type||"Insight",d=((o=(t=e.content)==null?void 0:t.split(`
`)[0])==null?void 0:o.trim().substring(0,50))||"";d?n=`${l}: ${d}`:n=`${l}`}if(!confirm(`Are you sure you want to delete this insight?

"${n}"`))return;let a=c.loading("Deleting insight...");try{await this.plugin.getAPIClient().deleteInsight(e.id),c.hideNotice(a),c.success("Insight deleted"),i.info("Deleted insight:",e.id),await this.loadInsights()}catch(l){c.hideNotice(a),i.error("Failed to delete insight",l),c.error(`Failed to delete insight: ${l.message||"Unknown error"}`)}}catch(n){i.error("Error in deleteInsight",n),c.error("Failed to delete insight")}}};w();E();var de=class extends S.Plugin{async onload(){i.info("Loading Open Notebook plugin"),await this.loadSettings(),i.setDebugEnabled(this.settings.enableDebugLogging),this.apiClient=new M(this.settings.apiEndpoint,this.settings.apiPassword,this.settings.requestTimeout,this.settings.retryAttempts),this.featureDetector=new O(this.apiClient),this.settings.detectedFeatures&&this.featureDetector.loadFeatures(this.settings.detectedFeatures),this.notebookManager=new J(this.apiClient,this.settings),this.contentSyncManager=new ne(this),this.syncIndicatorManager=new ie(this),this.offlineQueue=new ae(this.apiClient,async e=>{this.settings.offlineQueue=e,await this.saveSettings()}),await this.offlineQueue.initialize(this.settings.offlineQueue||[]),this.offlineQueue.startAutoProcess(),this.notebookCommands=new ee(this.app,this,this.notebookManager),this.notebookCommands.registerCommands(),this.transformCommands=new se(this.app,this),this.transformCommands.registerCommands(),this.transformCommands.setupContextMenu(),this.registerFileEventHandlers(),this.registerActiveFileChangeHandler(),this.registerView(I,e=>new x(e,this)),this.addRibbonIcon("message-circle","Toggle Open Notebook Chat",()=>{this.toggleChatView()}),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar(),this.addSettingTab(new Y(this.app,this)),this.registerCommands(),this.registerContextMenu(),this.settings.syncOnStartup?this.verifySyncStateOnStartup():this.contentSyncManager.setInitializationComplete(),i.info("Open Notebook plugin loaded")}async verifySyncStateOnStartup(){try{i.info("Running startup sync verification...");let e=await this.contentSyncManager.verifySyncState();(e.resynced>0||e.removed>0)&&c.info(`Sync verification: ${e.resynced} resynced, ${e.removed} cleaned up`),e.failed>0&&c.warn(`Sync verification: ${e.failed} files failed`)}catch(e){i.error("Startup sync verification failed",e),c.error("Failed to verify sync state on startup")}finally{this.contentSyncManager.setInitializationComplete()}}async onunload(){this.offlineQueue&&await this.offlineQueue.cleanup(),this.app.workspace.detachLeavesOfType(I),i.info("Unloading Open Notebook plugin")}async loadSettings(){this.settings=Object.assign({},ye,await this.loadData())}async saveSettings(){await this.saveData(this.settings),i.setDebugEnabled(this.settings.enableDebugLogging),this.updateStatusBar(),this.apiClient&&(this.apiClient.setEndpoint(this.settings.apiEndpoint),this.apiClient.setPassword(this.settings.apiPassword),this.apiClient.setTimeout(this.settings.requestTimeout),this.apiClient.setRetryAttempts(this.settings.retryAttempts))}registerCommands(){this.addCommand({id:"test-connection",name:"Test API Connection",callback:async()=>{try{if(c.info("Testing connection..."),await this.apiClient.testConnection()){let t=await this.apiClient.getApiVersion();this.settings.apiVersion=t,c.info("Detecting API features...");let o=await this.featureDetector.detectFeatures();this.settings.detectedFeatures=o,await this.saveSettings();let n=this.featureDetector.getAvailableFeaturesList().length;this.setConnectionStatus("connected"),c.success(`Connected to Open Notebook (v${t}) - ${n} features available`)}else this.setConnectionStatus("error"),c.error("Connection test failed")}catch(e){i.error("Connection test failed",e),this.setConnectionStatus("error"),c.error(`Connection failed: ${e.message}`)}}}),this.addCommand({id:"open-chat",name:"Open Chat",callback:async()=>{await this.activateChatView()}}),this.addCommand({id:"sync-current-file",name:"Sync Current File to Open Notebook",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return t&&t.extension==="md"&&t.parent&&this.notebookManager.getNotebookForFolder(t.parent.path)?(e||this.syncCurrentFile(),!0):!1}}),this.addCommand({id:"sync-folder",name:"Sync Folder to Open Notebook",callback:async()=>{let e=this.app.workspace.getActiveFile();e&&e.parent?await this.syncFolder(e.parent):c.warn("Please open a file in a folder to sync that folder")}}),this.addCommand({id:"open-settings",name:"Open Settings",callback:()=>{this.app.setting.open(),this.app.setting.openTabById(this.manifest.id)}}),this.addCommand({id:"refresh-sync-indicators",name:"Refresh Sync Indicators",callback:()=>{var e;i.info("Manually refreshing sync indicators"),(e=this.syncIndicatorManager)==null||e.refreshAll(),c.info("Sync indicators refreshed")}}),this.addCommand({id:"verify-sync-state",name:"Verify Sync State (Reconcile with Open Notebook)",callback:async()=>{try{c.info("Verifying sync state...");let e=await this.contentSyncManager.verifySyncState(),t=[`Verified: ${e.verified}`,e.resynced>0?`Resynced: ${e.resynced}`:null,e.removed>0?`Cleaned up: ${e.removed}`:null,e.failed>0?`Failed: ${e.failed}`:null].filter(Boolean).join(", ");c.success(`Sync verification complete. ${t}`)}catch(e){i.error("Sync verification failed",e),c.error(`Failed to verify sync state: ${e.message||"Unknown error"}`)}}}),this.addCommand({id:"check-conflicts",name:"Check for Sync Conflicts",checkCallback:e=>{let t=this.app.workspace.getActiveFile();return!t||t.extension!=="md"?!1:(e||this.checkFileConflicts(t),!0)}}),this.addCommand({id:"browse-podcasts",name:"Browse Podcasts",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t||!t.parent)return!1;let o=this.notebookManager.getNotebookForFolder(t.parent.path);return o?(e||this.openPodcastModal(o,t.parent.name),!0):!1}}),this.addCommand({id:"search-open-notebook",name:"Search Open Notebook",callback:()=>{new ce(this.app,this).open()}}),this.addCommand({id:"browse-insights",name:"Browse AI Insights",checkCallback:e=>{let t=this.app.workspace.getActiveFile();if(!t||t.extension!=="md")return!1;let o=this.contentSyncManager.getSyncStatus(t.path);if(!o||!o.sourceId)return!1;if(!e){let n=o.sourceId,r=t.basename;new Q(this.app,this,n,r).open()}return!0}}),this.addCommand({id:"ask-open-notebook",name:"Ask Open Notebook",callback:async()=>{var o;let e=await this.promptForQuery();if(!e)return;let t=c.loading("Asking Open Notebook...");try{let n=await this.apiClient.ask(e);c.hideNotice(t);let r=(o=this.app.workspace.activeEditor)==null?void 0:o.editor;if(r)r.replaceSelection(`

**Q:** ${e}

**A:** ${n}

`),c.success("Answer inserted");else{let a=`Answer - ${e.substring(0,50)}.md`,l=`# ${e}

${n}
`;await this.app.vault.create(a,l),c.success("Answer saved to new note")}}catch(n){c.hideNotice(t),i.error("Ask failed",n),c.error(`Failed to get answer: ${n.message||"Unknown error"}`)}}}),this.addCommand({id:"retry-offline-queue",name:"Retry Offline Operations",callback:async()=>{let e=this.offlineQueue.getQueueSize();if(e===0){c.info("No operations in queue");return}c.info(`Retrying ${e} queued operations...`),await this.offlineQueue.processQueue();let t=this.offlineQueue.getQueueSize();t===0?c.success("All operations completed"):c.warn(`${t} operations still in queue`)}}),this.addCommand({id:"clear-offline-queue",name:"Clear Offline Queue",callback:async()=>{let e=this.offlineQueue.getQueueSize();if(e===0){c.info("Queue is already empty");return}await this.offlineQueue.clearQueue(),c.success(`Cleared ${e} operations from queue`)}}),this.addCommand({id:"full-sync",name:"Full Sync (All Mapped Folders)",callback:async()=>{try{c.info("Starting full sync of all mapped folders...");let e=this.settings.folderToNotebook,t=Object.keys(e);if(t.length===0){c.warn("No folders are mapped to notebooks");return}let o=0,n=0;for(let r of t){let a=this.app.vault.getAbstractFileByPath(r);if(a instanceof S.TFolder){let l=await this.contentSyncManager.syncFolder(a,e[r]);o+=l.synced,n+=l.failed}}o>0&&(this.settings.lastSyncTimestamp=Date.now(),await this.saveSettings()),n===0?c.success(`Full sync complete: ${o} files synced`):c.warn(`Full sync complete: ${o} synced, ${n} failed`)}catch(e){i.error("Full sync failed",e),c.error(`Full sync failed: ${e.message||"Unknown error"}`)}}}),this.addCommand({id:"new-chat-session",name:"New Chat Session",callback:async()=>{await this.activateChatView();let e=this.app.workspace.getLeavesOfType(I);if(e.length>0){let t=e[0].view;if(t instanceof x){let o=this.app.workspace.getActiveFile();if(o&&o.parent){let n=this.notebookManager.getNotebookForFolder(o.parent.path);n?(await t.setNotebook(n),c.success("New chat session created")):c.warn("No notebook linked to current folder")}else c.warn("No active file with notebook context")}}}}),this.addCommand({id:"transform-selection",name:"Transform Selection",editorCheckCallback:(e,t,o)=>{let n=t.getSelection();return!n||n.trim().length===0?!1:(e||this.transformSelection(t),!0)}}),this.addCommand({id:"list-notebooks",name:"List Notebooks",callback:async()=>{try{let t=await this.getAPIClient().getNotebooks(!1);if(t.length===0){c.info("No notebooks found");return}let o=t.map((h,m)=>{let g=this.notebookManager.getFolderForNotebook(h.id),y=g?` \u2192 ${g}`:" (not mapped)";return`${m+1}. ${h.name}${y}`}).join(`
`),n=new class extends S.Plugin{onload(){}}(this.app,this.manifest),r=document.body.createDiv({cls:"modal-container mod-dim"});r.addEventListener("click",h=>{h.target===r&&r.remove()});let a=r.createDiv({cls:"modal"});a.createEl("h3",{text:"Open Notebook - Notebooks"}),a.createDiv({cls:"on-notebooks-list-content"}).setText(o),a.createDiv({cls:"modal-button-container"}).createEl("button",{text:"Close",cls:"mod-cta"}).addEventListener("click",()=>r.remove());let p=h=>{h.key==="Escape"&&(r.remove(),document.removeEventListener("keydown",p))};document.addEventListener("keydown",p)}catch(e){i.error("Failed to list notebooks",e),c.error(`Failed to list notebooks: ${e.message||"Unknown error"}`)}}}),this.addCommand({id:"create-notebook-from-folder",name:"Create Notebook from Folder",callback:async()=>{let e=this.getAllFolders();if(e.length===0){c.warn("No folders found in vault");return}let t=await this.promptForFolder(e);if(!t)return;let o=this.app.vault.getAbstractFileByPath(t);o instanceof S.TFolder&&await this.notebookCommands.createNotebookFromFolder(o)}}),this.addCommand({id:"link-folder-to-notebook",name:"Link Folder to Notebook",callback:async()=>{let e=this.getAllFolders();if(e.length===0){c.warn("No folders found in vault");return}let t=await this.promptForFolder(e);if(!t)return;let o=this.app.vault.getAbstractFileByPath(t);o instanceof S.TFolder&&await this.notebookCommands.linkFolderToNotebook(o)}}),this.addCommand({id:"unlink-folder-from-notebook",name:"Unlink Folder from Notebook",callback:async()=>{let e=this.settings.folderToNotebook,t=Object.keys(e);if(t.length===0){c.warn("No folders are currently linked to notebooks");return}let o=await this.promptForFolder(t);if(!o)return;let n=this.app.vault.getAbstractFileByPath(o);n instanceof S.TFolder&&await this.notebookCommands.unlinkFolder(n)}})}async promptForQuery(){return new Promise(e=>{let t=new class extends S.Plugin{onload(){}}(this.app,this.manifest),o=document.body.createDiv({cls:"modal-container mod-dim"});o.addEventListener("click",p=>{p.target===o&&(o.remove(),e(null))});let n=o.createDiv({cls:"modal"});n.createEl("h3",{text:"Ask Open Notebook"});let r=n.createEl("input",{type:"text",placeholder:"Enter your question...",cls:"on-prompt-input"}),a=n.createDiv({cls:"modal-button-container"}),l=a.createEl("button",{text:"Ask",cls:"mod-cta"}),d=a.createEl("button",{text:"Cancel"});l.addEventListener("click",()=>{o.remove(),e(r.value.trim()||null)}),d.addEventListener("click",()=>{o.remove(),e(null)}),r.addEventListener("keydown",p=>{p.key==="Enter"?(o.remove(),e(r.value.trim()||null)):p.key==="Escape"&&(o.remove(),e(null))});let u=p=>{p.key==="Escape"&&(o.remove(),e(null),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u),r.focus()})}registerFileEventHandlers(){this.registerEvent(this.app.vault.on("create",e=>{e instanceof S.TFile&&e.extension==="md"&&this.contentSyncManager.onFileCreated(e)})),this.registerEvent(this.app.vault.on("modify",e=>{e instanceof S.TFile&&e.extension==="md"&&this.contentSyncManager.onFileModified(e)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof S.TFile&&e.extension==="md"&&this.contentSyncManager.onFileDeleted(e)})),this.registerEvent(this.app.vault.on("rename",(e,t)=>{e instanceof S.TFile&&e.extension==="md"&&this.contentSyncManager.onFileRenamed(e,t)})),i.info("File event handlers registered")}registerActiveFileChangeHandler(){this.registerEvent(this.app.workspace.on("active-leaf-change",async e=>{let t=this.app.workspace.getLeavesOfType(I);if(t.length===0)return;let n=t[0].view;if(!(n instanceof x))return;let r=this.app.workspace.getActiveFile();if(!r||!r.parent){n.showNotLinked();return}let a=this.notebookManager.getNotebookForFolder(r.parent.path);if(!a){n.showNotLinked();return}await n.setNotebook(a)})),i.info("Active file change handler registered")}async syncCurrentFile(){let e=this.app.workspace.getActiveFile();if(!e){c.warn("No active file. Open a markdown file to sync.");return}if(e.extension!=="md"){c.warn("Can only sync markdown files");return}if(!e.parent){c.warn("File has no parent folder");return}let t=this.notebookManager.getNotebookForFolder(e.parent.path);if(!t){c.warn(`Folder "${e.parent.path}" is not linked to any notebook. Right-click the folder to link it.`);return}let o=c.loading(`Syncing ${e.basename}...`);try{await this.contentSyncManager.syncFile(e,t),this.settings.lastSyncTimestamp=Date.now(),await this.saveSettings(),c.hideNotice(o),c.success(`Synced: ${e.basename}`)}catch(n){c.hideNotice(o),i.error("Failed to sync file",n),c.error(`Failed to sync ${e.basename}: ${n.message||"Unknown error"}`)}}async generateInsightForFile(e,t){let o=c.loading("Generating insight...");try{let n=this.getAPIClient(),r=await n.getTransformations();if(!r||r.length===0){c.hideNotice(o),c.warn("No transformations available. Please create a transformation first.");return}let a=r[0].id;i.info(`Generating insight with transformation: ${a}`);let l=await n.generateInsight(t,a);c.hideNotice(o),c.success(`Insight generated: ${l.title||"Untitled"}`),i.info("Generated insight:",l.id)}catch(n){c.hideNotice(o),i.error("Failed to generate insight",n),c.error(`Failed to generate insight: ${n.message||"Unknown error"}`)}}openPodcastModal(e,t){let{PodcastModal:o}=(Te(),ue(Ie));new o(this.app,this,e,t).open()}async checkFileConflicts(e){try{let o=(await this.contentSyncManager.getSyncMetadata(e)).on_source_id;if(!o){c.info("File is not synced to Open Notebook");return}c.info("Checking for conflicts...");let n=await this.contentSyncManager.checkForConflict(e,o);if(n){let{ConflictModal:r}=await Promise.resolve().then(()=>(xe(),Ae));new r(this.app,n,async a=>{a==="local"?await this.contentSyncManager.resolveConflict(n,!0):a==="remote"?await this.contentSyncManager.resolveConflict(n,!1):c.info("Conflict resolution cancelled")}).open()}else c.success("No conflicts detected - file is in sync")}catch(t){i.error("Failed to check for conflicts",t),c.error(`Failed to check for conflicts: ${t.message||"Unknown error"}`)}}async syncFolder(e){let t=this.notebookManager.getNotebookForFolder(e.path);if(!t){c.warn("Folder is not linked to any notebook. Right-click the folder to link it.");return}let o=c.loading(`Syncing folder: ${e.name}...`);try{let n=await this.contentSyncManager.syncFolder(e,t);n.synced>0&&(this.settings.lastSyncTimestamp=Date.now(),await this.saveSettings()),c.hideNotice(o),n.synced===0&&n.failed===0?c.info("All files are already up to date"):n.failed===0?c.success(`Successfully synced ${n.synced} file${n.synced===1?"":"s"}`):n.synced===0?c.error(`Failed to sync ${n.failed} file${n.failed===1?"":"s"}`):c.warn(`Synced ${n.synced}, failed ${n.failed}`)}catch(n){c.hideNotice(o),i.error("Failed to sync folder",n),c.error(`Failed to sync folder: ${n.message||"Unknown error"}`)}}updateStatusBar(){var h;let{connectionStatus:e,showSyncStatus:t,lastSyncTimestamp:o}=this.settings;if(!t){this.statusBarItem.setText("");return}let n=e==="connected"?"connected":e==="error"?"error":"disconnected";this.statusBarItem.empty();let r=this.statusBarItem.createDiv({cls:"open-notebook-status-bar"}),a=r.createDiv({cls:`status-indicator ${n}`}),l=r.createSpan({text:"Open Notebook",cls:"status-text"}),d=((h=this.offlineQueue)==null?void 0:h.getQueueSize())||0;if(d>0&&r.createSpan({text:` (${d})`,cls:"status-queue-count"}).setAttribute("title",`${d} operation${d===1?"":"s"} in queue`),o){let g=Date.now()-o,y=this.formatTimeAgo(g);r.createSpan({text:` \u2022 ${y}`,cls:"status-sync-time"}).setAttribute("title",`Last synced: ${new Date(o).toLocaleString()}`)}this.statusBarItem.onclick=()=>{this.app.setting.open(),this.app.setting.openTabById(this.manifest.id)};let p=`Open Notebook: ${e==="connected"?"Connected":e==="error"?"Connection Error":"Disconnected"}`;d>0&&(p+=`
${d} operation${d===1?"":"s"} in queue`),o&&(p+=`
Last synced: ${new Date(o).toLocaleString()}`),this.statusBarItem.setAttribute("aria-label",p)}formatTimeAgo(e){let t=Math.floor(e/1e3),o=Math.floor(t/60),n=Math.floor(o/60),r=Math.floor(n/24);return r>0?`${r}d ago`:n>0?`${n}h ago`:o>0?`${o}m ago`:t>10?`${t}s ago`:"just now"}setConnectionStatus(e){this.settings.connectionStatus=e,this.settings.lastConnectionCheck=Date.now(),this.updateStatusBar(),this.saveSettings()}registerContextMenu(){i.info("Registering context menu for folders and files"),this.registerEvent(this.app.workspace.on("file-menu",(e,t,o)=>{t instanceof S.TFolder?this.addFolderContextMenu(e,t):t instanceof S.TFile&&t.extension==="md"&&this.addFileContextMenu(e,t)})),this.registerEvent(this.app.workspace.on("files-menu",(e,t,o)=>{t.length>0&&t.every(n=>n instanceof S.TFolder)&&t[0]instanceof S.TFolder&&this.addFolderContextMenu(e,t[0])})),this.registerEvent(this.app.workspace.on("editor-menu",(e,t,o)=>{let n=t.getSelection();n&&n.trim().length>0&&this.addEditorContextMenu(e,t,n)})),i.info("Context menu events registered successfully")}addFileContextMenu(e,t){let o=this.contentSyncManager.getSyncStatus(t.path);o&&o.sourceId&&(e.addSeparator(),e.addItem(n=>{n.setTitle("Generate AI Insight").setIcon("sparkles").onClick(async()=>{await this.generateInsightForFile(t,o.sourceId)})}),e.addItem(n=>{n.setTitle("Browse Insights").setIcon("list").onClick(()=>{new Q(this.app,this,o.sourceId,t.basename).open()})})),e.addSeparator(),e.addItem(n=>{n.setTitle("Transform Note").setIcon("wand-glyph").onClick(async()=>{await this.transformFile(t)})}),e.addItem(n=>{n.setTitle("Quick Summary").setIcon("list-collapse").onClick(async()=>{await this.transformFile(t,"Simple Summary")})}),e.addItem(n=>{n.setTitle("Quick Insights").setIcon("lightbulb").onClick(async()=>{await this.transformFile(t,"Key Insights")})})}async transformFile(e,t){try{let o=await this.app.vault.read(e);if(!o||o.trim().length===0){c.warn("File is empty");return}if(t){let{TransformResultModal:n}=await Promise.resolve().then(()=>(U(),te)),r=new n(this.app,this);r.open();try{let a=this.getAPIClient(),d=(await a.getTransformations()).find(p=>p.id===t||p.name.toLowerCase()===t.toLowerCase().replace("_"," "));if(!d){r.setError(`Transformation "${t}" not found`);return}let u=await a.executeTransformation(d.id,o);r.setResult({transformation:d,originalText:o,transformedText:u.output,context:{type:"file",file:e,onRetry:()=>{this.transformFile(e,t)}}})}catch(a){i.error("Failed to execute transformation",a),r.setError(a.message||"Unknown error occurred during transformation")}}else{let{TransformModalWithResult:n}=await Promise.resolve().then(()=>($e(),De));new n(this.app,this,e).open()}}catch(o){i.error("Failed to transform file",o),c.error(`Failed to transform file: ${o.message||"Unknown error"}`)}}addFolderContextMenu(e,t){i.debug(`Adding context menu for folder: ${t.path}`);let o=this.notebookManager.getNotebookForFolder(t.path);e.addSeparator(),o?(e.addItem(n=>{n.setTitle("Sync Folder to Open Notebook").setIcon("refresh-cw").onClick(async()=>{await this.syncFolder(t)})}),e.addItem(n=>{n.setTitle("Browse Podcasts").setIcon("mic").onClick(()=>{this.openPodcastModal(o,t.name)})}),e.addItem(n=>{n.setTitle("Unlink from Open Notebook").setIcon("unlink").onClick(async()=>{await this.notebookCommands.unlinkFolder(t)})})):(e.addItem(n=>{n.setTitle("Create Open Notebook").setIcon("plus-circle").onClick(async()=>{await this.notebookCommands.createNotebookFromFolder(t)})}),e.addItem(n=>{n.setTitle("Link to Open Notebook").setIcon("link").onClick(async()=>{await this.notebookCommands.linkFolderToNotebook(t)})}))}addEditorContextMenu(e,t,o){i.debug("Adding context menu for text selection"),e.addSeparator(),e.addItem(n=>{n.setTitle("Transform Selection").setIcon("wand-glyph").onClick(async()=>{await this.transformSelection(t)})}),e.addItem(n=>{n.setTitle("Quick Summary").setIcon("list-collapse").onClick(async()=>{await this.transformSelectionWith(t,o,"Simple Summary")})}),e.addItem(n=>{n.setTitle("Quick Insights").setIcon("lightbulb").onClick(async()=>{await this.transformSelectionWith(t,o,"Key Insights")})})}async transformSelectionWith(e,t,o){try{let n=this.getAPIClient(),a=(await n.getTransformations()).find(u=>u.id===o||u.name.toLowerCase()===o.toLowerCase().replace("_"," "));if(!a){c.warn(`Transformation "${o}" not found`);return}let{TransformResultModal:l}=await Promise.resolve().then(()=>(U(),te)),d=new l(this.app,this);d.open();try{let u=await n.executeTransformation(a.id,t);d.setResult({transformation:a,originalText:t,transformedText:u.output,context:{type:"selection",onAccept:p=>{e.replaceSelection(p)},onRetry:()=>{this.transformSelectionWith(e,t,o)}}})}catch(u){i.error("Failed to execute transformation",u),d.setError(u.message||"Unknown error occurred during transformation")}}catch(n){i.error("Failed to transform selection",n),c.error(`Failed to transform selection: ${n.message||"Unknown error"}`)}}getAPIClient(){return this.apiClient}getNotebookManager(){return this.notebookManager}getContentSyncManager(){return this.contentSyncManager}getSyncIndicatorManager(){return this.syncIndicatorManager}getFolderMapping(e){return this.notebookManager.getNotebookForFolder(e)}getFeatureDetector(){return this.featureDetector}async toggleChatView(){let{workspace:e}=this.app,t=e.getLeavesOfType(I),o=e.rightSplit;if(t.length>0){if(o)if(o.collapsed){o.expand();let r=t[0].view;if(r instanceof x){let a=e.getActiveFile();if(!a||!a.parent)r.showNotLinked();else{let l=this.notebookManager.getNotebookForFolder(a.parent.path);l?await r.setNotebook(l):r.showNotLinked()}}}else o.collapse()}else await this.activateChatView()}async activateChatView(){let{workspace:e}=this.app,t=null,o=e.getLeavesOfType(I);if(o.length>0?t=o[0]:(t=e.getRightLeaf(!1),t&&await t.setViewState({type:I,active:!0})),t){e.revealLeaf(t);let n=t.view;if(n instanceof x){let r=e.getActiveFile();if(r&&r.parent){let a=this.notebookManager.getNotebookForFolder(r.parent.path);a&&await n.setNotebook(a)}}}}async transformSelection(e){let t=e.getSelection();if(!t||t.trim().length===0){c.warn("No text selected");return}try{let o=this.getAPIClient(),n=await o.getTransformations();if(!n||n.length===0){c.warn("No transformations available");return}let r=await this.promptForTransformation(n);if(!r)return;let a=n.find(u=>u.id===r);if(!a)return;let{TransformResultModal:l}=await Promise.resolve().then(()=>(U(),te)),d=new l(this.app,this);d.open();try{let u=await o.executeTransformation(r,t);d.setResult({transformation:a,originalText:t,transformedText:u.output,context:{type:"selection",onAccept:p=>{e.replaceSelection(p)},onRetry:()=>{this.transformSelection(e)}}})}catch(u){i.error("Failed to execute transformation",u),d.setError(u.message||"Unknown error occurred during transformation")}}catch(o){i.error("Failed to transform selection",o),c.error(`Failed to transform selection: ${o.message||"Unknown error"}`)}}async promptForTransformation(e){return new Promise(t=>{let o=document.body.createDiv({cls:"modal-container mod-dim"});o.addEventListener("click",u=>{u.target===o&&(o.remove(),t(null))});let n=o.createDiv({cls:"modal"});n.createEl("h3",{text:"Select Transformation"});let r=n.createDiv({cls:"on-modal-list-container"});e.forEach(u=>{let p=r.createDiv({cls:"on-modal-list-item"});p.createDiv({cls:"on-modal-list-item-title"}).setText(u.name),u.description&&p.createDiv({cls:"on-modal-list-item-description"}).setText(u.description),p.addEventListener("click",()=>{o.remove(),t(u.id)})}),n.createDiv({cls:"modal-button-container"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>{o.remove(),t(null)});let d=u=>{u.key==="Escape"&&(o.remove(),t(null),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d)})}getAllFolders(){let e=[],t=o=>{e.push(o.path);for(let n of o.children)n instanceof S.TFolder&&t(n)};return t(this.app.vault.getRoot()),e.sort()}async promptForFolder(e){return new Promise(t=>{let o=document.body.createDiv({cls:"modal-container mod-dim"});o.addEventListener("click",u=>{u.target===o&&(o.remove(),t(null))});let n=o.createDiv({cls:"modal"});n.createEl("h3",{text:"Select Folder"});let r=n.createDiv({cls:"on-modal-list-container"});e.forEach(u=>{let p=r.createDiv({cls:"on-folder-list-item"});p.setText(u||"(root)"),p.addEventListener("click",()=>{o.remove(),t(u)})}),n.createDiv({cls:"modal-button-container"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>{o.remove(),t(null)});let d=u=>{u.key==="Escape"&&(o.remove(),t(null),document.removeEventListener("keydown",d))};document.addEventListener("keydown",d)})}};
